---
title: "R Notebook"
#output: rmarkdown::github_document
output: html_notebook 
---

```{r}
#nejake kniznice
library(dplyr)
library(tidyverse)
library(data.table)
library(corrplot)
library(RColorBrewer)
library(rcompanion)
library(lawstat)
library(moments)
library(forcats)
library(car)
library(ggpubr)
```

## Dáta
V tejto sekcii bude opísaný základný zdroj dát + postup, akým sme získali náš unikátny dataset - bolo potrebné vykonať viacero krokov, ktoré zahŕňali spájanie viacerých datasetov, elimináciu niektorých atribútov, deduplikáciu a na záver vytváranie úplne nových relevantných atribútov na základe hodnôt niektorých atribútov pôvodného datasetu.

### Tabuľka game
Tabuľka obsahuje základné dáta jednotlivých zápasov. Neobsahuje však detailné informácie o tímoch alebo tímových štatistikách konkrétneho zápasu. Taktiež neobsahuje čitateľné identifikátory tímov (t.j. ich názvy, obsahuje iba ID) Pomocou atribútov game_id, away_team_id a home_team_id však dokážeme namapovať iné tabuľky tak, aby sme dostali jeden dataset so všetkými pre nás relevantnými hodnotami.

```{r}
#setwd(dir) 
path <- ('data/game.csv')
game <- fread(path)
head(game)
```

Niektoré atribúty sú z pohľadu štatistiky nezaujímavé a teda ich môžeme odstrániť pred spájaním tabuliek. Napríklad údaje o časovej zóne, alebo identifikátory štadiónov a pododobne. Pri týchto atribútoch predpokladáme, že pre naše riešenie zaujímavé žiadnym spôsobom nebudú - samozrejme, využitie by sa určite nájsť dalo, no aj vzhľadom na predpokladaný počet atribútov nemáme potrebu tieto atribúty v datasete ponechať.

```{r}
game <- subset(game, select=-c(venue_link,venue_time_zone_id, venue_time_zone_offset, venue_time_zone_tz))
head(game)
dim(game)
```
```{r}
dim(game[game$season==20192020,])
dim(subset(game, season==20192020 & type=='P'))
```

Prvotnou analýzou sme zistili, že v minulej sezóne sa odohralo približne 2500 zápasov, z čoho bolo +-10 percent (231 zápasov) v playoff. Percentuálny pomer zápasov regulárnej a vyraďovacej časti nie je vhodný pre rozdelenie na trénovací a testovací dataset (tam je odporúčaný pomer 70:30, resp. 80:20). Náš prvotný predpoklad, že môžeme dataset trénovať na regulárnej sezóne a následne testovať na zápasoch play-off teda nebude ideálny - vhodnejší bude možno prístup rozdelenia podľa sezón, kedy na zápasoch starších sezón model natrénujeme a testovať ho budeme na novšej sezóne.


Počet hier v minulej sezóne bol omnoho vyšší ako je zvykom, tak sme skontrolovali existenciu duplikátnych záznamov v tabuľke. Z nasledujúceho výpisu sme odhalili 2570 duplikátov v celej tabuľke.

```{r}
game[duplicated(game)]
```
Aby sme si overili existenciu duplikátov, tak sme si vypísali náhodnú hru z vyššie vygenerovanej tabuľky duplikátov.

```{r}
game[game$game_id==2019020369]
```

Duplikáty sme eliminovali využitím funkcie distinct, ktorá zachová jedinečné záznamy. Elimináciu duplikátov sme overili opäť použitím funkcie duplicated, ktorá vrátila 0 záznamov. Počet záznamov v tabuľke klesol o 2570, aktuálny počet záznamov je teda 23735.

```{r}
game <- distinct(game)
game[duplicated(game)]
dim(game)
```

### Tabuľka game_teams_stats

Druhá tabuľka obsahuje špecifické štatistiky tímov k jednotlivým zápasom. Problémom je, že jeden záznam obsahuje štatistiky iba jedného tímu. Teda máme pre jeden záznam zápasu z tabuľky games dva záznamy v tabuľke game_teams_stats. 

```{r}
path <- ('data/game_teams_stats.csv')
game_teams_stats <- fread(path)
head(game_teams_stats)
```

Vyhodili sme atribúty, ktoré nám nepomôžu pri štatistickom vyhodnocovaní a vypísali sme si informácie o datasete. Všimli sme si, že údajov je viac ako dva-krát viac oproti záznamom v tabuľke game. To znamená, že niektoré záznamy sú duplicitné, alebo chybné.

```{r}
game_teams_stats <- subset(game_teams_stats, select=-c(head_coach, startRinkSide, goals))
head(game_teams_stats)
dim(game_teams_stats)
```
Podľa unikátnych identifikátorov zápasov vidíme, že ich je rovnako ako v tabuľke game. To znamená, že v tabuľke game_teams_stats máme duplikáty, ktoré budeme musieť odstrániť.

```{r}
length(unique(game_teams_stats$game_id))
```
### Tabuľka team_info

Táto tabuľka obsahuje iba základné infromácie o tímoch, ktoré nesúvisia so sezónami a zápasmi. Je však potrebná pre doplnenie mien tímov k jednotlivým hrám - tým spôsobom bude možné priradenie názvov tímov k záznamom a možné prípadné overenie zmysluplnosti hodnôt atribútov podľa reálnych výsledkov napr. na NHL portáli.

```{r}
path <- ('data/team_info.csv')
team_info <- fread(path)
head(team_info)
```

Z tejto tabuľky nám stačí extrahovať atribúty team_id, podľa ktorého spojíme tabuľky a abbreviation, ktorý nám doplní skratky názvov tímov ku zápasom - plné mená tímov potrebné nie sú, ako aj franchiseID alebo link na API.

```{r}
team_info <- subset(team_info, select=-c(franchiseId, link, shortName, teamName))
head(team_info)
dim(team_info)
```

### Spájanie tabuliek
V tejto sekcii vykonáme spojenie predom opisovanej trojice tabuliek, resp. troch datasetov do jedného, finálneho datasetu. Ten bude základom pre náš projekt, pričom na ňom budeme vykonávať EDA, MEDA, štatistické učenie, dokazovanie hypotéz a podobne.


```{r}
game_teams_stats <- left_join(game_teams_stats, team_info, "team_id")
head(game_teams_stats)
dim(game_teams_stats)
```
Unikátny počet ID tímov v datasete je 37 (výpis nižšie)
```{r}
length(unique(game_teams_stats$team_id))
```
Reálny počet tímov v NHL je však 31, čiže dataset obsahuje tímy navyše - táto skutočnosť je jednoducho vysvetliteľná, keďže dataset obsahuje zápasy od sezóny 2000, v ktorej hrávali tímy ktoré v dnešnej dobe už neexistujú (napr. Atlanta Trashers). Nápodobne, niektoré dnešné tímy v minulosti ešte neexistovali (napr. Las Vegas Golden Knights).



```{r}
df_h <- game_teams_stats[(game_teams_stats$HoA == 'home'),]
head(df_h)
dim(df_h)
df_h <- distinct(df_h)
unique(df_h$HoA)
```

```{r}
df_a <- game_teams_stats[(game_teams_stats$HoA == 'away'),]
head(df_a)
dim(df_a)
df_a <- distinct(df_a)
unique(df_a$HoA)
```

```{r}
df <- left_join(df_a, df_h, "game_id", suffix = c(".away", ".home"))
head(df)
dim(df)
```

```{r}
df <- left_join(game, df, "game_id")
head(df)
dim(df)
```

```{r}
dim(df[df$season==20192020,])
dim(subset(df, season==20192020 & type=='P'))
```
```{r}
dim(df[df$season==20182019,])
dim(subset(df, season==20182019 & type=='P'))
```
```{r}
dim(df[df$season==20172018,])
dim(subset(df, season==20172018 & type=='P'))
```
```{r}
dim(df[df$season==20162017,])
dim(subset(df, season==20162017 & type=='P'))
```

```{r}
glimpse(df)
```

Následne môžeme zo spojených datasetov odstrániť nepodstatné atribúty (atribútov je aj tak veľké množstvo, čize odstránenie nie dôležitých atribútov nám uľahčí prácu s datasetom). Taktiež si vytvoríme nový atribút reprezentujúci percentuálnu úspešnost zákrokov domáceho a hosťujúceho brankára, ktorú získame ako podiel striel na bránu - počet gólov vydelené celkovým počtom striel na bránu).

```{r}
df <- subset(df, select=-c(game_id, date_time_GMT, outcome, home_rink_side_start, venue, away_team_id, home_team_id, settled_in.away, HoA.away, HoA.home))
df <- rename(df, 'settled_in' = 'settled_in.home')
df <- rename(df, 'goals.away' = 'away_goals')
df <- rename(df, 'goals.home' = 'home_goals')
df$save_percentage.home = round((df$shots.away-df$goals.away)/df$shots.away, 4)
df$save_percentage.away = round((df$shots.home-df$goals.home)/df$shots.home, 4)
head(df)
dim(df)
```
Atribúty HoA.home a Hoa.away boli redundantné, keďže informáciu o domácom a hosťujúcom tíme máme zahrnutú v atribúte team_id.home a team_id.away.

## Prieskumná analýza datasetu

Kedže cieľom práce je práca na predikčnom modeli, bude vhodné nepracovať s celým datasetom ale iba poslednými sezónami. Dôvôdom je častá obmena kádrov tímov NHL, čo môže mať za následok drasticky odlíšne výkony tímov medzi sezónami. Práca s veľkým množstvom sezón bude mať pravdepodobne za následok nízku presnosť modelu a neprehľadnosť grafov. 
Dátovú množinu sme teda zmenšili na posledných 5 sezón, čo nám poskytne presnejšie výsledky pre aktuálne pravidlá zámorského hokeja.

```{r}
df <- df[df$season >= 20152016]
print(df)
```

charakteristika dát, ich rozdelenie a identifikácia problémov (+ riešenie).

```{r}
glimpse(df)

```
V datasete máme 31 atribútov. Vyšší počet je ich najmä z dôvodu potreby štatistík o hre z pohľadu oboch tímov ktoré odohrali zápas (preto máme počet atribútov cca zdvojnásobený). V tejto sekcii práce sa budeme venovať analýze jednotlivých atribútov, resp. dvojíc  atribútov.

### Atribút season
**charakteristika:** atribút reprezentuje sezónu, v ktorej sa odohral NHL zápas. Dataset obsahuje sezóny od roku 2015-2020.

```{r}
unique(df$season)
barplot(prop.table(table(df$season)), las=2, cex.names=.8, col=rgb(0.2,0.4,0.6,0.6), ylab="%", xlab="", main="Percentuálne rozdelenie atribútu season")
mtext(text = "season", side = 1,line = 4)
table(df$season)
```
Z grafu môžeme vidieť, že dataset obsahuje 5 zvolených sezón. Rozdelenie počtu hier v sezónach je percentuálne približne rovnaké (+- 3%), pričom najmenej odohraných hier bolo v poslednej sezóne - pravdepodobne zapríčinené pandemickou situáciou. Posledná sezóna v datasete je ročník 2019/2020, keďže aktuálna sezóna 2020/2021 ešte nie je ukončená a teda nie je súčasťou datasetu.

### Atribút type
**charakteristika:** atribút reprezentuje typ odohraného zápasu. Nadobúda tri základné hodnoty:

* R - regular, označuje regulárne zápasy ktoré sa hrajú počas NHL sezóny
* P - playoff, označuje zápasy vyraďovacej časti NHL, hrajú sa na konci sezóny. Tejto časti sa zúčastňujú iba najlepšie tímy.
* A - ?, predpokladáme že exhibičné zápasy
```{r}
cat("Unikátne hodnoty: \n")
unique(df$type)
cat(" \n Percentuálny podiel: \n")
cat("R = ", (100/nrow(df))*nrow(df[df$type=='R']), "%\n")
cat("P = ", (100/nrow(df))*nrow(df[df$type=='P']), "%\n")
cat("A = ", (100/nrow(df))*nrow(df[df$type=='A']), "%\n")
cat(" \n Počet výskytov:")
table(df$type)
barplot(prop.table(table(df$type)), las=2, cex.names=.8, col=rgb(0.2,0.4,0.6,0.6), ylab="%", xlab="type", main="Percentuálne rozdelenie atribútu type")
```
Z početností jednotlivých atribútov môžeme vidieť obrovskú prevahu zápasov regulárnej časti sezóny, čo aj zodpovedá skutočnosti. Použitie regulárnej sezóny na realizáciu trénovacieho datasetu a playoff na realizáciu testovacieho datatsetu nie je vhodné, pretože percentuálny podiel 92:7 nesedí s odporúčaným pomerom 70:30, alebo 80:20. Z tohoto dôvodu bude potrebné dodatočné prerozdelenie zápasov regulárnej sezóny tak, aby bol tento pomer splnený - bude riešené neskôr v práci. Hodnotu NA nemá žiaden atribút.

Hodnotu 'A' nadobúda len 5 záznamov, v žiadnom z nich sa nejedná o zápasy tímov NHL (abbreviation = NA).
```{r}
subset(df, type=='A')
```
 V zdroji datasetu nie je vysvetlené, čo hodnota "A" v atribúte type reprezentuje. Predpokladáme, že sa jedná o exhibičné zápasy, pretože atribúty tímov nie sú namapované na žiadne NHL tímy.

### Atribúty goals.home a goals.away
**charakteristika:** atribút reprezentuje počet gólov z pohľadu domáceho a hosťovského tímu.

Nejedná sa o spojitý atribút - počet gólov môže nadobúdať iba celé hodnoty, jedná sa teda o diskrétny atribút.
Už z podstaty atribútov **goals.gome** a **goals.away** vieme povedať, že sa nebude jednať o normálne rozdelenie, ale o distribúciu naklonenú vpravo (skewed right)  - toto vieme poznamenať ešte pred vizualizáciou prostredníctvom histogramov. Taktiež bude pravdepodobne obsahovať vychýlené hodnoty, keďže sa zvyknú vyskytovať zápasy s nadmerným počtom gólov. Reálny priemer sa však zvykne pohybovať okolo hodnoty 2 góly pre tím - predpokladáme, že v datasete tomu tak bude tiež. Na začiatku si teda oba atribúty vizualizujeme prostredníctvom krabicových grafov a histogramov, aby sme mohli overiť naše iniciálne predpoklady.

```{r}
cat("Základná štatistika pre goals.home", "\n")
summary(df$goals.home)
cat("\n","Základná štatistika pre goals.away", "\n")
summary(df$goals.away)
```
Zo základnej štatistiky vieme povedať, že hodnoty sú koncentrované okolo počtu gólov 3 - konkrétne na základu priemeru a mediánu (menej citlivý na vychýlené hodnoty). Maximálny počet gólov pre domáce aj hosťujúce tímy je v oboch prípadoch 10. Podľa tretieho kvantilu = 4 vieme povedať, že hodnota 10 pôsobí vychýlene. Najvyššia koncentrácia vyzerá bude v pri hodnotách 2,3,4.

```{r}
boxplot(df$goals.home, ylab="Home goals", xlab="", main="Krabicový graf gólov domáceho tímu")
hist(df$goals.home, xlab="Home goals", main="Histogram výskytov gólov domáceho tímu")
abline(v = c(mean(df$goals.home),  median(df$goals.home)), col=c("green", "blue"), lty=c(2,3), lwd=c(3,3))
boxplot(df$goals.away, ylab="Away goals", xlab="", main="Krabicový graf gólov hosťujúceho tímu")
hist(df$goals.away, xlab="Away goals", main="Histogram výskytov gólov hosťujúceho tímu")
abline(v = c(mean(df$goals.home),  median(df$goals.home)), col=c("green", "blue"), lty=c(2,3), lwd=c(3,3))
```
Dodatočne ešte overíme, či neexistujú chýbajúce hodnoty týchto atribútov v niektorých záznamoch:
```{r}
cat("Počet záznamov kde je goals.home NA", nrow(subset(df, is.na(goals.home)==TRUE)), '\n')
cat("Počet záznamov kde je goals.away NA",nrow(subset(df, is.na(goals.away)==TRUE)),'\n')
```
Ani jeden záznam nenadobúda pri atribútoch goals.home a goals.away NA hodnoty, preto nebude potrebné riešiť voľbu stratégie dopĺňania týchto hodnôt.


Už z vizualizácií atribútov vidíme, že predpoklady boli korektné. Histogramy oboch atribútov sú veľmi podobné - obe majú distribúciu naklonenú vpravo, určite sa nebude jednať o normálne rozdelenie - z tohoto dôvodu netreba ani vykonávať test normality.
Z histogramov možno vyčítať, že domáci tím strelí v priemere viac gólov ako hosťujúci tím - zatiaľ čo pri hosťujúcich tímoch nadobúdajú záznamy najčastejšie hodnotu 0 gólov, pri domácich tímoch je maximálna frekvencia pri hodnote 2 góly. Z tejto skutočnosti môžeme vyvodiť hypotézu, že domáce prostredie môže mať reálny vplyv na priemerný počet strelených gólov, resp. vonkajšie prostredie znižuje priemerný počet strelených gólov. 
Pri krabicových grafoch možno sledovať úplnú identitu týchto grafov pre oba atribúty, čo je zaujímavý jav, keďže histogramy sú mierne odlišné. Väčšina hodnôt sa pohybuje v rozmedzí 2-4 góly, čiže náš počiatočný predpoklad bol čiastočne korektný. Vychýlené hodnoty sú v oboch prípadoch počet 8, 9 a 10 gólov. Pre overenie si tieto maximálne hodnoty pre oba atribúty vypíšeme, pričom zaujímavý bude najmä počet záznamov, ktorý tieto hodnoty nadobúda.

```{r}
subset(df, goals.home >= 8)
cat("Počet vychýlených hodnôt atribútu goals.home podľa krabicového grafu:", nrow(subset(df, goals.home >= 8)))
```


```{r}
subset(df, goals.away >= 8)
cat("Počet vychýlených hodnôt atribútu goals.away podľa krabicového grafu:", nrow(subset(df, goals.away >= 8)))
```
Z výpisov vidíme, že počet zápasov v ktorých domáci tím strelil 8 a viac gólov je 48, zatiaľ čo počet zápasov v ktorých vonkajší tím strelil 8 a viac gólov je 23 - tento fakt len podporuje hypotézu, že domáce prostredie má reálny vplyv na množstvo strelených gólov. Krabicový graf tieto hodnoty označuje ako vychýlené, no keďže obsahujú dôležité informácie a jedná sa o reálne hodnoty (nie napr. chyby senzorov), tieto hodnoty nie je vhodné odstraňovať a ani normovať, resp. zrážat na nižšiu hodnotu.

V analýze atribútu budeme pokračovat prostredníctvom QQplotu, ktorý zobrazuje odchylku od teoretického normálneho rozdelenia.
```{r}
qqnorm(df$goals.home, main="Q-Q Plot atribútu goals.home")
qqline(df$goals.home, col = "red", lwd = 2)
```
```{r}
qqnorm(df$goals.away, main="Q-Q Plot atribútu goals.away")
qqline(df$goals.away, col = "red", lwd = 2)
```


Ako už bolo spomínane v úvode analýzy týchto atribútov, nejedná sa o spojité hodnoty - táto skutočnost je viditeľná aj na grafe, kedy hodnoty atribútu **goals.home** nie sú spojité - toto správanie je očakávané, keďže počty gólov musia byť celé čisla. Z grafov môžeme vidieť, že počet gólov sa vychyľuje od teoretického normálneho rozdelenia.


```{r}
plotNormalDensity(df$goals.home, main = "Diagram hustoty atribútu goals.home")
```


```{r}
plotNormalDensity(df$goals.away, main = "Diagram hustoty atribútu goals.away")
```
Z oboch diagramov hustoty môžeme vidieť už predom spomínaný fakt - atribúty **goals.home** a **goals.away** nepochádzajú z normálneho rozdelenia - výrazne vychýlené od krivky hustoty normálneho rozdelenia sú najmä hodnoty v intervale od (1-5 gólov) na x-ovej osi. Kostrbatosť grafu spôsobuje fakt, že dáta nie sú spojité.

```{r}
plot(x=df$goals.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE,main = "Diagram rozptýlenia atribútu goals.home")
```

```{r}
plot(df$goals.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE, main = "Diagram rozptýlenia atribútu goals.away")
```
Z grafov rozptýlenia vidieť, že podobne ako bolo viditeľné ak v krabicovom grafe, vychýlené hodnoty sú pri počte gólov >=8 - vychýlenosť idnikuje menšia hustota záznamov nadobúdajúcich hodnoty atribútov **goals.home** a **goals.away** >= 8 (na grafe viditeľné ako pomerne výrazný pokles "bodiek"). Ako už však bolo spomínané, odstránenie alebo úprava týchto hodnôt by so sebou niesla riziko straty dôležitých informácií - preto bude vhodné tieto hodnoty ponechať, keďže sa jedná o reálne údaje. Z grafu nie je príliš dobre vidieť, pre aký počet gólov je najväčšia koncentrácia záznamov (príliš veľa záznamov spôsobuje nízku čitateľnosť grafu) - už z krabicového grafu však vieme, že najvyššia koncentrácia je v rozmedzí 2-4 gólov, čiže táto informácia už nie je kľúčová.


```{r}
#TU NEJAKY GRAF ESTE
```


**Zhrnutie**: atribúty **goals.home** a **goals.away** sú diskrétne atribúty, ktoré nepochádzajú z normálneho rozdelenia (viditeľné na histogramoch, QQ-plotoch a grafoch hustoty), ich distribúcia je podľa očakávaní naklonená vpravo. Z grafov rozptýlenia a krabicových grafov vidieť, že za vychýlené hodnoty možno pri oboch atribútoch považovať počty gólov väčšie rovné ako 8 - z dôvodu významnosti tejto informácie však tieto hodnoty neplánujeme nijako upravovať. Oba atribúty možno z hľadiska plánovaných hypotéz považovať za kľúčové.

### Atribúty team_id.home a team_id.away
**charakteristika:** Identifikačné číslo NHL tímu v rámci datasetu.

Aktuálne sa v NHL nachádza 31 tímov, pričom sa tento počet od sezóny 2015/2016 nezmenil. Overíme, či sa v datatsete sedí počet tímov a pozrieme sa aj na počet hier každého tímu, ktorý sa môže meniť pri účasti vo vyraďovacej fáze.

```{r}
length(table(df$team_id.home))
table(df$team_id.home)
barplot(table(df$team_id.home), las=2, cex.names=.8, xlab="Frequency", ylab="Team ID", main="Počet hier pre domáce tímy", horiz=TRUE, xlim=c(0,250), space=c(1,1,1,1), col=c("salmon2"))
table(df$team_id.away)
barplot(table(df$team_id.away), las=2, cex.names=.8, xlab="Frequency", ylab="Team ID", main="Počet hier pre hosťujúce tímy", horiz=TRUE, xlim=c(0,250), space=c(1,1,1,1), col=c("salmon2"))
```

Zistili sme, že v datasete je viac ako 31 tímov. Taktiež z grafov môžeme vidieť, že niektoré tímy odohrali iba pár zápasov. Tieto zápasy si vypíšeme nižšie. Ostatné tímy majú približne rovnaký počet zápasov ~(200-230).

```{r}
df[df$team_id.away >= 55]
```
Z výpisu môžeme vidieť, že tímy s nízkym počtom zápasov sú exhibičné tímy, ktoré sme úvadzali vyššie - nejedná sa o tímy NHL. Tieto záznamy teda bude potrebné odstrániť.

### Atribúty won.home a won.away
**charakteristika:** jedná sa o boolean atribúty, vyjadrujú ktorý tím v zápase zvíťazil. V drtivej väčšine prípadov sú opačné, t.j TRUE FALSE alebo FALSE TRUE. Môže však nastať aj situácia v ktorej majú oba hodnotu FALSE - keďže remízy v týchto sezónach neboli povolené, tieto hodnoty by sa reálne v datasete vyskytovať pri legitímnych záznamoch nemali.

```{r}
unique(df$won.home)
unique(df$won.away)
subset(df, won.home==TRUE & won.away==TRUE)
subset(df, won.home==FALSE & won.away==FALSE)
verify <- subset(df, won.home==FALSE & won.away==FALSE)
```

Výsledok zápasu TRUE TRUE nie je možný. Preto je potrebné skontrolovať, či sa v datasete tento výsledok nenachádza (ak áno je potrebné ho opraviť). Po kontrole s vysužitím funkcie unique sme zistili, že TRUE TRUE sa v datasete nachádza 0x. FALSE FALSE sa vŠak v datasete nachádza 14x - po pohľade na dáta vieme povedať, že sa nebude jednať o remízy - pre záznamy chýbajú dáta, pravdepodobne sa bude jednať o odložené alebo zrušené zápasy. Žiaden z týchto zápasov však pre naše riešenie nemá pridanú hodnotu - keďže chýbajú všetky relevantné štatistické atribúty (resp. ich hodnota je 0), tieto zápasy môžeme úplne bez problémov z datasetu pri čistení odstrániť - nestratíme totižto žiadnu štatisticky cennú informáciu.

```{r}
unique(verify$season)
```


```{r}
table(is.na(df$won.home))
table(is.na(df$won.away))
```

Atribúty won.home a won.away neobsahujú žiadne prázdne hodnoty, preto nie je potrebné voliť stratégie ich nahrádzania.

### Atribúty shots.home a shots.away
**charakteristika:** atribút reprezentuje počet striel na bránu z pohľadu domáceho a hosťovského tímu.

Pri atribútoch overíme, či neobsahujú chýbajúce hodnoty:
```{r}
cat("Počet záznamov kde je shots.home NA", nrow(subset(df, is.na(shots.home)==TRUE)), '\n')
cat("Počet záznamov kde je shots.away NA",nrow(subset(df, is.na(shots.away)==TRUE)),'\n')
```
Vidíme, že v štyroch záznamoch nadobúdajú atribúty shots.home a shots.away hodnotu NA. Na tieto záznamy sa môžeme bližšie pozrieť.

```{r}
subset(df, is.na(shots.home)==TRUE)
subset(df, is.na(shots.away)==TRUE)
```
Z výpisu vidíme, že v oboch prípadoch sa jedná o zápasy play-off medzi tímami NHL, ktoré vŠak neobsahujú žiade štatistické informácie (takmer všetko je NA) - tieto záznamy bude vhodné odstrániť, keďže neobsahujú žiadne relevantné informácie, pravdepodobne sa jedná o zrušené zápasy v play-off. Taktiež je vhodné podotknúť, že tieto 4 zápasy sú rovnaké pre oba atribúty, t.j. po ich odstránení budú odstránené NA hodnoty pre oba atribúty - bude riešené vo fázi čistenia dát.


```{r}
boxplot(df$shots.home, ylab="Home shots", xlab="", main="Krabicový graf striel na bránu domáceho tímu")
hist(df$shots.home, xlab="Home shots", main="Histogram striel na bránu domáceho tímu")
boxplot(df$shots.away, ylab="Away shots", xlab="", main="Krabicový graf striel na bránu hosťujúceho tímu")
hist(df$shots.away, xlab="Away shots", main="Histogram striel na bránu hosťujúceho tímu")
```
 
 Z histogramov možno vidieť, že distribúcia atribútov shots.home a shots.away pripomína normálnu distribúciu. Taktiež možno sledovať odlahľú hodnotu - konkrétne počet striel 0. Ako sme už zistili, jedná sa o chýbajúce záznamy, ktoré budú neskôr odstránené. Predpokladáme teda, že táto odľahlá hodnota bude po fáze čistenia dát eliminovaná. Ohľadom hodnôt atribútov vieme povedať, že aj pri **shots.home** aj **shots.away** nadobúdajú atribúty veľmi podobné hodnoty - najväčšia koncentrácia záznamov je okolo 30 striel. Pri prvom pohľade na histogram však vyzerá, že hosťujúce tímy mávajú v priemere o niečo málo viac striel na bránu ako domáce, čo je zaujímavé, keďže domáce tímy mávajú priemerne viac gólov na zápas (ako bolo opísané v analýze atribútov **goals.home** a **goals.away**).
 
Pri krabicových grafoch je zaujímavý najmä atribút **shots.home** - konkrétne pomerne výrazne odľahlá hodnota okolo 80 striel na bránu
(najbližšia druhá je okolo 60 striel). Pri atribúte **shots.away** - sú všetky "odľahlé" hodnoty združené okolo hodnoty 60 striel. Počet 80+ striel teda na prvý pohľad pôsobí podozrivo - tento záznam si vypíšeme aby sme zistili, či sa môže jednať o chybu merania. Odľahlá hodnota je taktiež hodnota 0, dôvod jej výskytu + postup riešenia sme však už riešili pri opise histogramu.

```{r}
subset(df, df$shots.home >= 80)
```
Z výpisu záznamu vidíme, že sa jedná o zápas play-off medzi Columbus Blue Jackets a Tamba Bay Lightning, kedy bol počet striel na jednej strane 88 a na druhej 63. Zápas bol taktiež ukončený v predĺžení - keďže v play-off je možný nekonečný počet predĺžení až pokiaľ nie je jasný výsledok zápasu (remíza vo vyraďovacích zápasoch nie je povolená) môžeme predpokladať, že sa jedná o zápas ktorý bol predĺžovaný viac krát. Počty striel sú teda legitímne a nejedná sa o chyby merania. Jedná sa však o veľmi unikátnu situáciu, ktorá môže potenciálne negatívne ovplyvniť výsledky predikčného modelu. Z tohoto dôvôdu je vhodné uvažovať nad normovaním tejto hodnoty.


```{r}
qqnorm(df$shots.home, main="Q-Q Plot atribútu shots.home")
qqline(df$shots.home, col = "red", lwd = 2)
```
Z QQ-plotu atribútu **shots.home** môžeme vidieť, že sa pomerne pekne drží teoretickej krivky normálneho rozdelenia. Síce sa jedná o diskrétnu celočíselnú hodnotu, graf nie je taký kostrbatý ako pri atribútoch **goals.home** a **goals.away** - je tomu tak preto, že atribút shots dosahuje širší interval hodnôt a tým pádom na grafe skoky medzi hodnotami nie je vidieť. Okolo počtu gólov 3 sa začína rozdelenie mierne odchylovať od krivky normálneho rozdelenia. Za zmienku stoja aj vychýlené hodnoty v 0 (už opísané aj zdôvodnené) a výrazne vychýlená hodnota 80 - jedná sa o reálnu hodnotu, no nad jej normalizáciou budeme uvažovať keďže situáciu, v ktorej hodnota bola nadobudnutá je možno považovať za extremálnu.

```{r}
qqnorm(df$shots.away, main="Q-Q Plot atribútu shots.away")
qqline(df$shots.away, col = "red", lwd = 2)
```
Pri QQ-plote atribútu **shots.away** vieme poznamenať v podstate to isté ako pri atribúte **shots.home**. Rozdielom však je pomerne prudšie vychýlenie od teoretickej krivky normálneho rozdelenia pre pri počte striel väčšom rovnom ako 40. Výrazne vychýlená hodnota ako v predošlom grafe tu však nie je, všetky nadobúdajú hodnoty okolo 60 (bolo viditeľné už z krabicového grafu). Vyzerá to však tak, že distribúcia normálna nebude a bude potrebná normalizácia atribútu tak, aby sme normálne rozdelenie dosiahli.

```{r}
plotNormalDensity(df$shots.home, main = "Diagram hustoty atribútu shots.home")
```

```{r}
plotNormalDensity(df$shots.away, main = "Diagram hustoty atribútu shots.away")
```
Grafy hustoty indikujú takmer ideálnu hustotu atribútov **shots.home** a **shots.away** - vyzerá to tak, že atribúty budú mať normálnu distribúciu. Z predošlých grafov však máme dôvod o tejto skutočnosti pochybovať, bude teda pravdepodobne potrebné vykonať test normality na reprezentatívnej vzorke dát o veľkosti 1000.


```{r}
plot(x=df$shots.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE,main = "Diagram rozptýlenia atribútu shots.home")
```
Diagram rozptýlenia atribútu **shots.home** indikuje primánrne zoskupenie hodnôt v intervale od 20-40 striel na bránu, rovnako ako krabicový graf. Opätovne môžeme vidieť extrémnu vychýlenosť hodnoty 88 striel na bránu. Hodnoty 0 sú chýbajúce záznamy, vyjadrovať sa k nim teda nie je potrebné.

```{r}
plot(x=df$shots.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE,main = "Diagram rozptýlenia atribútu shots.away")
```
Diagram rozptýlenia atribútu **shots.away** indikuje opäť primárne zoskupenie hodnôt v intervale od 20-40 striel na bránu, rovnako ako predošlý graf rozptýlenia. Neexistuje extrémne vychýlená hodnota, tým pádom je os Y grafu posunutá. Údaje získané z grafov však vyzerajú v oboch atribútoch veľmi podobne. 

Grafy indikujú signifikantnú podobnosť s normálnym rozdelením. Bude preto vhodné vykonať Shapiro-Wilkov test normality, pre ktorý je potrebné vybrať reprezentatívnu vzorku o veľkosti 1000.
```{r}
sample <- sample_n(df, 1000)
hist(sample$shots.home, xlab="Home shots", main="Histogram reprezentatívnej vzorky striel na bránu hosťujúceho tímu")
hist(sample$shots.away, xlab="Away shots", main="Histogram reprezentatívnej vzorky striel na bránu hosťujúceho tímu")
cat("Štatistika shots.home\n")
summary(df$shots.home)
cat("Štatistika vzorky shots.home\n")
summary(sample$shots.home)
cat("Štatistika shots.away\n")
summary(df$shots.away)
cat("Štatistika vzorky shots.away\n")
summary(sample$shots.away)
```
Zo základnej deskriptívnej štatistiky možno vidieť veľmi podobnú varianciu hodnôt vo vzorkách (dolný-horný kvantil, priemer a medián), preto ich považujeme za reprezentatívne (aj keď neobsahujú všetky extremálne hodnoty).

Následne vykonáme už predom spomínaný Shapiro-Wilkov test normality s hladinou p = 0.05.

Test normality atribútu **shots.home**:
nulová hypotéza: dáta pochádzajú z normálneho rozdelenia
```{r}
shapiro.test(sample$shots.home)
```
Keďže p < 0.05, nulovú hypotézu zamietame - dáta nepochádzajú z normálneho rozdelenia

Test normality atribútu **shots.away**:
nulová hypotéza: dáta pochádzajú z normálneho rozdelenia
```{r}
shapiro.test(sample$shots.away)
```
Keďže p < 0.05, nulovú hypotézu zamietame - dáta nepochádzajú z normálneho rozdelenia.

Test normality bol v pri oboch atribútoch zamietnutý, preto vieme, že ani jeden atribút nepochádza z normálneho rozdelenia - pravdepodobná je mierna asymteria distribúcií atribútov.

**Zhrnutie**: atribúty **shots.home** a **shots.away** sú diskrétne atribúty, ktoré nepochádzajú z normálneho rozdelenia (dokázané Shapiro-Wilkovým testom). Hodnota **shots.home** dosahuje výrazne vychýlenú hodnotu 88, pri ktorej však bola zistená jej validita (t.j. jedná sa o valídnu hodnotu a nie chybu senzora). Túto hodnotu pravdepodobne bude vhodné normalizovať napr. pomocou horného kvantilu, keďže je naozaj extremálna. Atribúty **shots.home** a **shots.away** sú na grafov veľmi podobné, dosahujú miernu asymetriu. Vychýlené hodnoty 0 sa vyskytujú v oboch atribútoch, bolo však zistené, že sa jedná o chýbajúce záznamy (zrušené/presunuté zápasy) - tie budú vyriešené pri fáze čistenia dát.


### Atribúty hits.home a hits.away
**charakteristika:** atribút obsahuje hodnoty počtu narazení domáceho a hosťujúceho tímu. Narazenia, resp. osobné súboje vznikajú počas hry a pripočítavajú sa na stranu tímu, ktorý narazenie inicioval. Preto sa hodnoty medzi súperiacimi tímami nemusia rovnať.

```{r}
summary(df$hits.home)
summary(df$hits.away)
```
Zo zhrnutia môžeme vidieť, že hodnoty môžu byť pravdivé, resp. neobsahujú čísla, ktoré by logicky nemohli nastať. Taktiež vidíme, že v štyroch záznamoch nám chýbajú hodnoty tohoto atribútu.

```{r}
df[is.na(df$hits.home)]
df[is.na(df$hits.away)]
```
Väčšina zo záznamov s chýbajúcimi hodnotami, je z jednej sezóny. Vyzerá to ako preložené, alebo zrušené zápasy a budeme sa na to musieť pozrieť.

```{r}
hist(df$hits.home)
hist(df$hits.away)
```
Diagram pripomína normálne rozdelenie hodnôt, ale obsahuje niekoľko vychýlených hodnôt, ktoré mohli nastať z dôvodu dlhších zápasov, napr. predĺženia.

```{r}
boxplot(df$hits.home)
boxplot(df$hits.away)
```
Vidíme, že niektoré hodnoty sú veľmi vychýlené a mali by sme ich zmenšiť. Takéto vychýlené hodnoty nastávajú pri netradičných zápasoch, alebo derby, ktré sa konajú na zamrznutých jazerách. Preto môžeme hodnoty znížiť, alebo zmeniť na najčastejšiu hodnotu.

```{r}
qqnorm(df$hits.home, pch = 1, frame = FALSE)
qqline(df$hits.home, col = "steelblue", lwd = 2)
qqPlot(df$hits.home)
qqnorm(df$hits.away, pch = 1, frame = FALSE)
qqline(df$hits.away, col = "steelblue", lwd = 2)
qqPlot(df$hits.away)
```
Z grafov môžeme vidieť, že hodnoty sa približujú normálnemu rozdeleniu, ale pri vyšších hodnotách sú odchylky vyššie. Môžeme analyzovať tieto hodnoty a skúsiť ich normalizovať.

```{r}
plot(density(na.omit(df$hits.home)))
plotNormalDensity(df$hits.home)
plot(density(na.omit(df$hits.away)))
plotNormalDensity(df$hits.away)
```
Rozdelenie hodnôt veľmi pripomína normálne rozdelenie, pričom je voči krivke posunuté. Pre tento atribút bude potrebné spraviť test normality, aby sme si boli istý o aké rozdelenie sa jedná.

```{r}
plot(df$hits.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
plot(df$hits.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
```
Z grafu hustoty vidíme, že hodnoty sú rozmanité, čo logicky sedí k zápasom NHL. No taktiež vidíme, že niektoré hodnoty sú veľmi riedke, hlavne najväčšie hodnoty a najmenšie. 
 
### Atribúty pim.home a pim.away
**charakteristika:** atribút hovorí o počte trestných minút pre jednotlivé tímy. Keďže sú najčastejšie vylúčenia sankciované dvoma minútami, tak sa budú párne hodnoty vyskytovať častejšie. No poznáme aj dlhšie tresty ako 2+2, 5, 5+2, alebo aj netradičné tresty. Vylúčenia do konca zápasu za nešportové správanie sa do tejto štatistiky nezarátavajú.

```{r}
summary(df$pim.home)
summary(df$pim.away)
```
Zo zhodnotenia vidíme, že hodnoty sú priateľné a dávajú logicky zmysel, ale maximálne hodnoty sú veľmi vychýlené a záznamy majú chýbajúcu hodnotu pre tento atribút. 

```{r}
hist(df$pim.home)
hist(df$pim.away)
```
Podľa grafu neobsahuje atribút normálne rozdelenie. Hodnoty skôr pripomínajú long-tail rozdelenie.

```{r}
boxplot(df$pim.home)
boxplot(df$pim.away)
```
Krabicový graf nám iba potvrdil, že atribút obsahuje viacero vychýlených hodnôt, na ktoré sa budeme musieť pozrieť a navrhnúť možnú úpravu.

```{r}
qqnorm(df$pim.home, pch = 1, frame = FALSE)
qqline(df$pim.home, col = "steelblue", lwd = 2)
qqPlot(df$pim.home)
qqnorm(df$pim.away, pch = 1, frame = FALSE)
qqline(df$pim.away, col = "steelblue", lwd = 2)
qqPlot(df$pim.away)
```
Q-Q grafy nám dokázali, že sa nejedná o normálne rozdelenie a hodnoty sa mu ani nepribližujú.


```{r}
plot(density(na.omit(df$pim.home)))
plotNormalDensity(df$pim.home)
plot(density(na.omit(df$pim.away)))
plotNormalDensity(df$pim.away)
plot(df$pim.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
plot(df$pim.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
```
Atribút má veľmi nezvyčajú hustotu rozdelenia hodnôt, čo je zapríčinené hlavne z dvôdou dvojminutových trestov.

 
### Atribúty powerPlayOpportunities.home a powerPlayOpportunities.away
**charakteristika:** atribút hovorí o gólových príležitostiach počas presilových hier. Tento atribút sa odvíja od počtu presilovkových minút a teda očakávame medzi nimi koreláciu.

```{r}
boxplot(df$powerPlayOpportunities.home)
hist(df$powerPlayOpportunities.home)
boxplot(df$powerPlayOpportunities.away)
hist(df$powerPlayOpportunities.away)
```
Z grafov môžeme vidieť, hodnoty atribútu pripomínajú normálne rozdelenie s malým počtom vychýlených hodnôt. 
 
 
### Atribúty powerPlayGoals.home a powerPlayGoals.away
**charakteristika:** atribút reprezentuje počet presilovkových gólov pre oba tímy. Presilovkové góly sú v NHL časté, ale veľké počty presilovkových góolov sú nezvyčajné. Väčšinou je úspešnosť presiloviek okolo 20%, čo znamená jeden gól z piatich presilových hier.

```{r}
boxplot(df$powerPlayGoals.home)
hist(df$powerPlayGoals.home)
boxplot(df$powerPlayGoals.away)
hist(df$powerPlayGoals.away)
```
Grafy nám odhalili naklonené rozdelenia s malým počtom vychýlených hodnôt, ktoré môžeme neskôr analyzovať.
 
### Atribúty faceOffWinPercentage.home a faceOffWinPercentage.away
**charakteristika:** atribút hovorí o percentuálnom počte vyhratých vhadzovaní. Spolu tvorí atribút pre domácich a hostí 100% vhadovaní. 

```{r}
boxplot(df$faceOffWinPercentage.home)
hist(df$faceOffWinPercentage.home)
boxplot(df$faceOffWinPercentage.away)
hist(df$faceOffWinPercentage.away)
```
Atribút sa veľmi podobá normálnemu rozdeleniu, pričom obsahuje zopár vychýlených hôdnot, ako napr. 0, ktorá logicky nedáva zmysel a budeme sa na ňu musieť pozrieť.
 
### Atribúty giveaways.home a giveaways.away
**charakteristika:** atribút reprezentujúci odovzdané puky súperiacemu tímu bez súboja. Takýchto situácií sa v zápasoch vyskytuje viacero a nie sú nezvyčajným javom zápasu NHL.

```{r}
boxplot(df$giveaways.home)
hist(df$giveaways.home)
boxplot(df$giveaways.away)
hist(df$giveaways.away)
```
Hodnoty jemne pripomínajú normálne rozdelenie, ale je tam veľa vychýleých hodnôt, ktoré nemusia znamenať chyby merania.
 
### Atribúty takeaways.home a takeaways.away
**charakteristika:** atribút, ktorý reprezentuje počet odobraných pukov súperiacemu tímu. Tento atribút nie je komplementom vyššie spomenutého atribútu odovzdania pukov.

```{r}
boxplot(df$takeaways.home)
hist(df$takeaways.home)
boxplot(df$takeaways.away)
hist(df$takeaways.away)
```
 
### Atribúty blocked.home a blocked.away
**charakteristika:** atribút súčtu zablokovaných striel na bránu. hráčmi, inými ako brankár. To znamená, že hráč zablokuje strelu na bránu hokejkou, korčuľou, alebo telom a puk sa vôbec nedostane k brankárovi. Zabkovania strely nie sú nezvyčajné v NHL, ale nevyskytujú sa vo veľkých počtoch, ako napr. strely na bránku.

```{r}
boxplot(df$blocked.home)
hist(df$blocked.home)
boxplot(df$blocked.away)
hist(df$blocked.away)
```
Hodnoty atribútu veľmi pripomínajú normálne rozdeleni, ale vidíme aj zopár vychýlených hodnôt, čo môže byť z dôvodu dlhší hier, napr. kvôli predĺženiu.
 
### Atribúty abbreviation.home a abbreviation.away
**charakteristika:** atribút, ktoréh hodnoty obsahujú iba tri písmená a reprezentuje skratkú tímov., ktoré prosti sebe nastúpili v zápase. Pre nami vybrané sezóny bolo v NHL 31 tímov a teda má tento atribút 31 unikátnych hodnôt.


### Atribúty settled_in.home a settled_in.away
**charakteristika:** atribút, ktorý ukazuje ako skončil zápas. V NHL môže zápas skončiť viacerými spôsobmi: v riadnom hracom čase, v predĺžení, po nájazdoch (v starších sezónach), alebo z netradičných dôvodov (roztopenie ľadu, výpadok elektrického prúsu, ...).

 
### Atribúty save_percentage.home a save_percentage.away
**charakteristika:** Tento atribút reprezentuje úspešnosť brankára v precentách. Úspešnosť brankára nie je súčasťou pôvodného datasetu - atribút sme si vytvorili a údaje doplnili na základe hodnôt z iných atribútov.

```{r}
summary(df$save_percentage.home)
summary(df$save_percentage.away)
```
Hodnoty úspešnosti brankárov sme vypočítali sami a poskytujú veľmi podobné priemerné hodnoty, ako uvádza oficiálna nHL stránka. Môžeme ale vidieť, že 14 záznamov má tento atribút nevyplnený.

```{r}
hist(df$save_percentage.home)
hist(df$save_percentage.away)
```
Graf nám ukazuje, že hodnoty netvoria normálne rozdelenie. Skôr sú naklonené napravo s malým počtom vychýlených hodnôt.

```{r}
boxplot(df$save_percentage.home)
boxplot(df$save_percentage.away)
```
Vychýlené hodnoty sú zo spodného kvantilu a nie je ich veľa. Môžeme sa na ne pozrieť a zhodnotiť ich úpravu.

```{r}
qqnorm(df$save_percentage.home, pch = 1, frame = FALSE)
qqline(df$save_percentage.home, col = "steelblue", lwd = 2)
qqPlot(df$save_percentage.home)
qqnorm(df$save_percentage.away, pch = 1, frame = FALSE)
qqline(df$save_percentage.away, col = "steelblue", lwd = 2)
qqPlot(df$save_percentage.away)
```
Grafy nám ukazujú, že sa nejedná o normálne rozdelenie, pretože vrchné a spodné hodnoty majú vysokú odchylku.

```{r}
plot(density(na.omit(df$save_percentage.home)))
plotNormalDensity(df$save_percentage.home)
plot(density(na.omit(df$save_percentage.away)))
plotNormalDensity(df$save_percentage.away)
```
Grafy hustoty s krivkou normálneho rozdelenia nám ukazujp, že hodnoty sa veľmi podobajú normálnemu rozdeleniu, ale obsahujú viacero lokálnych vrcholov, ktoré sú celkom nezvyčajné.

```{r}
plot(df$save_percentage.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
plot(df$save_percentage.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
```
Graf hustoty hodnôt nám ukazuje, že medzi čístými výkonmi brankárov a inkasovaným aspoň jedným gólom je veľká medzera, čo znamená, že góly padajú aj pri menšom počte striel na bránu. Taktiež v niektorých zápasoch majú brankári veľmi majú percentuálnu úspešnosť, čo môže byť spôsobené zranením pri zákroku, z ktorého padol gól.

 

## Párová analýza

V tejto časti chceme identifikovať možné vzťahy medzi jednotlivými atribútmi prostredníctvom výpočtu korelácií, respektíve korelačnej matice.
Nakoľko niektoré atribúty obsahujú nenumerické hodnoty, pre prvotnú identifikáciu možných vzťahov medzi atribútmi použijeme iba atribúty s numerickými hodnotami. Čo sa týka nenumerických atribútov **won.home** a **won.away**, tie aktuálne obsahujú pravdivostné hodnoty TRUE alebo FALSe a teda ich môžeme zmeniť na numerické (nahradením TRUE za 1 a FALSE za 0).

```{r}
df$won.home[df$won.home == "TRUE"] <- "1"
df$won.home[df$won.home == "FALSE"] <- "0"
df$won.away[df$won.away == "TRUE"] <- "1"
df$won.away[df$won.away == "FALSE"] <- "0"
class(df$won.home) = "numeric"
class(df$won.away) = "numeric"
unique(df$won.home)
unique(df$won.away)
```

Pre vytvorenie korelačnej matice potrebujeme numerické atribúty. Vytvoríme si pomocný dataset, ktorý bude obsahovať iba numerické atribúty pôvodného datasetu.

```{r}
df_numeric <- subset(df, select=-c(type, abbreviation.away, settled_in, abbreviation.home))
sapply(df_numeric, is.numeric)
```

Z výpisu vyššie môžeme vidieť, že všetky atribúty pomocného datasetu **df_numeric** sú numerické. Môžeme vytvoriť korelačnú maticu.

```{r}
corrplot(cor(df_numeric, use="complete.obs"), type="lower", method="color", tl.col="black")
```

Z korelačnej matice môžeme vidieť, že najväčšia korelácia (záporná) je medzi atribútmi **won.home** a **won.away**, čo je pochopiteľné, pretože keď jeden tím vyhrá, druhý musí prehrať. Podobné záporné korelácie môžeme vidieť medzi atribútmi **faceOffWinPercentage.home** a **faceOffWinPercentage.away**, ktoré hovoria o vyhratých vhadzovaniach. Ďalšie korelácie sú medzi atribútmi **won.home** a **goals.home**:

```{r}
cor(df$won.home, df$goals.home)
```
```{r}
ggplot(df, aes(x=shots.home, y=goals.home, color=won.home)) + geom_point(size=1)
```


Korelácia týchto dvoch atribútov je tiež logická. Môžeme z nej vyvodiť, že čím viac gólov tím strelí, tým je väčšia šanca, že zápas vyhrá. Podobne to platí aj pre atribúty **won.away** a **goals.away**:

```{r}
cor(df$won.away, df$goals.away)
```
```{r}
ggplot(df, aes(x=shots.away, y=goals.away, color=won.away)) + geom_point(size=1)
```
```{r}
par(mfrow=c(2,1))
par(mar=c(0,5,3,3))
hist(df$goals.home[df$won.home == 1], main="Histogram počtu gólov podľa výsledku zápasu (home)" , ylab="Win", xlab="", ylim=c(0,200), xlim=c(0,11) , xaxt="n", las=1 , col="slateblue1", breaks=8)
par(mar=c(5,5,0,3))
hist(df$goals.home[df$won.home == 0], main="" , ylab="Loss", xlab="Goals", ylim=c(220,0), xlim=c(0,11), las=1 , col="tomato3"  , breaks=8)

par(mfrow=c(2,1))
par(mar=c(0,5,3,3))
hist(df$goals.away[df$won.away == 1], main="Histogram počtu gólov podľa výsledku zápasu (away)" , ylab="Win", xlab="", ylim=c(0,200), xlim=c(0,11) , xaxt="n", las=1 , col="slateblue1", breaks=8)
par(mar=c(5,5,0,3))
hist(df$goals.away[df$won.away == 0], main="" , ylab="Loss", xlab="Goals", ylim=c(220,0), xlim=c(0,11), las=1 , col="tomato3"  , breaks=6)
```

Rovnako môžeme sledovať aj koreláciu medzi atribútmi **won.away** a **goals.home** alebo **won.home** a **goals.away**. V tomto prípade však budú korelácie záporné:

```{r}
cor(df$won.away, df$goals.home)
cor(df$won.home, df$goals.away)
```

Ďalšiu koreláciu môžeme pozorovať medzi atribútmi **pim.home** a **pim.away**. Atribúty hovoria o trestných minutách tímov. Určitá korelácia je pochopiteľná, pretože ak sa napríklad dvaja hráči pobijú, idú obaja na trestnú lavičku. V takomto prípade dostávajú trestné minúty oba tíma zároveň, čoho dôsledkom je zvýšená korelácia týchto atribútov. Atribúty však obsahujú N/A hodnoty, takže ich pre znázornenie korelácie budeme ignorovať.

```{r}
cor(df$pim.home, df$pim.away, use="complete.obs")
```
```{r}
ggplot(df, aes(x=pim.home, y=pim.away)) + geom_point(size=1)
```

Trestné minúty jedného tímu znamenajú presilovku druhého tímu. Z toho tiež vyplýva korelácia medzi atribútmi **pim.home** s **powerPlayOpportunities.away** a naopak **pim.away** a **powerPlayOpportunities.home**:

```{r}
cor(df$pim.home, df$powerPlayOpportunities.away, use="complete.obs")
cor(df$pim.away, df$powerPlayOpportunities.home, use="complete.obs")
```
Z vyššie uvedených korelácií medzi jednotlivými atribútmi môžeme vytvoriť určité pracovné hypotézy, ktoré budeme v ďalších fázach projektu overovať.

Vhodné by bolo zobraziť aj úspešnosť brankárov pomocou grafov, ale nie je to zatiaľ možné, pretože atribút obsahuje aj iné/nenumerické hodnoty - NaN. Tento problém plánujeme vyriešiť pri čistení dát, po ktorom môžeme vykonať novú analýzu tohoto atribútu.

### Hypotézy
Počas fázy prieskumnej analýzy sme si stanovili 5 pracovných hypotéz, ktoré môžu byť vzhľadom na dáta zaujímavé. Tieto hypotézy sú nasledovné:

1. Tím, ktorý v zápase strelí viac ako 3 góly (vrátane), pravdepodobne vyhrá.

2. Čím je väčší súhrnný počet striel na bránu, tým viac gólov padne v zápase.

3. Čím je v zápase viac hitov, tým je zápas ostrejší a tým pádom rozhodcovia udelia tímom súhrnne viac trestných minút.

4. Čím má brankár vyššiu úspešnosť zákrokov, tým s väčšou pravdepodobnosťou jeho tím vyhrá.

5. Tím, ktorý hrá v domácom prostredí strelí viac gólov v zápase ako hosťujúci tím.

Vzťahy medzi atribútmi obshiahnutými v hypotézach bolo možné vidieť už pri prieskumnej analýze jednotlivých atribútov (EDA), ako aj pri párovej analýze (MEDA). Keďže závislosti existujú, predpokladáme, že väčšina hypotéz bude postavená dobre. Tieto hypotézy budú bližšie riešené vo fázi o štatistickom učení. V prvom rade však bude potrebné dáta vyčistit a upraviť takým spôsobom, aby boli použiteľné pre dodatočnú analýzu prostredníctvom metód štatistického učenia. Niektoré atribúty bude taktiež potrebné normalizovať - napr. logaritmom, odmocninou.


## Čistenie a úprava dát

V tejto kapitole sa venujeme čisteniu a úprave dát. Niektoré úpravy sme však spravili už pred analýzou. Tieto úpravy, ako napríklad deduplikáciu dát, bolo potrebné spraviť hneď na začiatku projektu, pretože sa týkali vytvárania datasetu, ktorý v projekte používame. Dataset sme vytvorili spojením 3 tabuliek. Okrem deduplikácie dát sme tiež odstránili niektoré atribúty a iné sme naopak pridali, respektíve vytvorili (ako napríklad vytvorenie atribútu úspešnosti brankára, ktorá sa počíta na základe gólov a striel oponenta).
Cieľom tejto kapitoly je, aby všetky záznamy obsahovali údaje pre všetky atribúty. Je teda potrebné odstrániť všetky N/A hodnoty.
Z analýzy atribútu **type** vieme, že náš dataset obsahuje výsledky niektorých zápasov, ktoré nespadajú do súťaže NHL. Pre začiatok sa pozrieme, aké atribúty obsahujú N/A hodnoty a následne odstránime dané zápasy, ktoré nepatria do NHL (takéto zápasy majú hodnotu atribútu **type** rovnú 'A').
Ako prvé však odstránime vychýlenú hodnotu z atribútu **shots.home**.

```{r}
boxplot(df$shots.home, ylab="Home shots", xlab="", main="Krabicový graf striel na bránu domáceho tímu")
```
Vychýlenú hodnotu nahradíme 75% kvantilom počtu striel domácich tímov v zápasoch, ktoré sa dohrali v predĺžení.

```{r}
df$shots.home[df$shots.home > 70] = quantile(df$shots.home[df$settled_in == 'OT'], 0.75)
```

Teraz skontrolujeme, či sa vychýlená hodnota nahradila.

```{r}
boxplot(df$shots.home, ylab="Home shots", xlab="", main="Krabicový graf striel na bránu domáceho tímu")
```
Na krabicovom grafe vyššie môžeme vidieť, že sme vychýlenú hodnotu zrazili. Teraz prejdeme na odstránenie N/A hodnôt. Ako prvé zistíme, ktoré všetky atribúty obsahujú N/A hodnoty.

```{r}
cbind(lapply(lapply(df, is.na), sum))
```
Ako bolo spomenuté, niektoré zápasy napatria do súťaže NHL. Niektoré atribúty môžu obsahovať N/A hodnoty práve z tohto dôvodu. Najskôr odstránime spomínané zápasy.

```{r}
table(df$type)
df = df[!(df$type == 'A')]
table(df$type)
```
Ako môžeme vidieť z výpisu vyššie, dataset už neobsahuje žiade zápasy, ktoré by mali hodnotu atribútu **type** rovnú 'A'. Teraz sa pozrieme, či to nejakým spôsobom ovplyvnilo počet N/A hodnôt ostatných atribútov.

```{r}
cbind(lapply(lapply(df, is.na), sum))
```
Môžeme si všimnúť, že zmizli všetky N/A hodnoty atribútov **abbrevation.away** a **abbreviation.home**. Teraz začneme postupne prechádzať ostatné atribúty obsahujúce N/A hodnoty, pričom navrhneme spôsob akým ich nahradíme.

```{r}
df[is.na(df$shots.away)]
```

Z výpisu záznamov, ktoré obsahujú N/A hodnotu v atribúte **shots_away** si môžeme všimnúť, že aj ďalšie atribúty majú N/A hodnoty. Môžeme predpokladať, že všetky N/A hodnoty (okrem atribútov **save_percentage.home** a **save_percentage.away**) v našom datasete sú obsiahnuté v práve týchto 4 konkrétnych zápasoch. Vypíšeme si čísla tímov jednotlivých atribútov, ktoré obsahujú N/A hodnoty. Ak sa čísla tímov budú zhodovať, znamená to, že všetky N/A hodnoty sú obsiahnuté v spomínaných 4 zápasoch.

```{r}
df$team_id.away[is.na(df$shots.away)]
df$team_id.away[is.na(df$hits.away)]
df$team_id.away[is.na(df$pim.away)]
df$team_id.away[is.na(df$powerPlayOpportunities.away)]
df$team_id.away[is.na(df$powerPlayGoals.away)]
df$team_id.away[is.na(df$faceOffWinPercentage.away)]
df$team_id.away[is.na(df$giveaways.away)]
df$team_id.away[is.na(df$takeaways.away)]
df$team_id.away[is.na(df$blocked.away)]
df$team_id.away[is.na(df$shots.home)]
df$team_id.away[is.na(df$hits.home)]
df$team_id.away[is.na(df$pim.home)]
df$team_id.away[is.na(df$powerPlayOpportunities.home)]
df$team_id.away[is.na(df$powerPlayGoals.home)]
df$team_id.away[is.na(df$faceOffWinPercentage.home)]
df$team_id.away[is.na(df$giveaways.home)]
df$team_id.away[is.na(df$takeaways.home)]
df$team_id.away[is.na(df$blocked.home)]
```
```{r}
df$team_id.home[is.na(df$shots.away)]
df$team_id.home[is.na(df$hits.away)]
df$team_id.home[is.na(df$pim.away)]
df$team_id.home[is.na(df$powerPlayOpportunities.away)]
df$team_id.home[is.na(df$powerPlayGoals.away)]
df$team_id.home[is.na(df$faceOffWinPercentage.away)]
df$team_id.home[is.na(df$giveaways.away)]
df$team_id.home[is.na(df$takeaways.away)]
df$team_id.home[is.na(df$blocked.away)]
df$team_id.home[is.na(df$shots.home)]
df$team_id.home[is.na(df$hits.home)]
df$team_id.home[is.na(df$pim.home)]
df$team_id.home[is.na(df$powerPlayOpportunities.home)]
df$team_id.home[is.na(df$powerPlayGoals.home)]
df$team_id.home[is.na(df$faceOffWinPercentage.home)]
df$team_id.home[is.na(df$giveaways.home)]
df$team_id.home[is.na(df$takeaways.home)]
df$team_id.home[is.na(df$blocked.home)]
```
Z výpisov môžeme vidieť, že sa čísla tímov pre všetky atribúty obsahujúce N/A hodnoty opakujú. Z toho vyplýva, že všetky N/A hodnoty v našom datasete sú z práve týchto 4 konkrétnych zápasov. Tieto zápasy pre nás teda nemajú žiadny prínos, pretože im chýbajú hodnoty veľkého množstva atribútov. Z tohto dôvodu nebudeme N/A hodnoty nijakým spôsobom nahrádzať a záznamy o daných zápasoch z datesetu jednoducho vymažeme.

```{r}
df = df[!(is.na(df$shots.away))]
cbind(lapply(lapply(df, is.na), sum))
```
Ako môžeme vidieť z výpisu vyššie, po odstránení záznamov, ktoré obsahujú N/A hodnoty v atribúte **shots.away**, zmizli všetky N/A hodnoty z celého datasetu okrem atribútov **save_percentage.home** a **save_percentage.away**. Teraz skontrolujeme tieto dva atribúty.

```{r}
df[is.na(df$save_percentage.away)]
```

Z výpisu vyššie môžeme vidieť, že 10 N/A hodnôt v **save_percentage.home** je pri rovnakých zápasoch ako pri atribúte **save_percentage.away**. Tiež si môžeme všimnúť, že tieto hodnoty vznikli z dôvodu delenia nulou (pri výpočte save_percentage vyhádzame z rozdielu počtu striel a počtu gólov, pričom výsledok ešte delíme počtom striel, t. j. v prípade, že počet striel je 0, výsledkom je NaN, pretože nulou nedelíme). Tiež si môžeme všimnúť, že všetky ostatné atribúty v týchto zápasoch majú hodnotu 0. Aj keby sme nahradili save_percentage 100-percentnou úspešnosťou, nemali by nás tieto zápasy žiadnu výpovednú hodnotu. Tieto zápasy teda môžeme odstrániť.

```{r}
df = df[!(is.na(df$save_percentage.away))]
```

Po odstránení spomínaných zápasov overíme, že dataset už neobsahuje žiadne N/A hodnoty.

```{r}
cbind(lapply(lapply(df, is.na), sum))
```

Ako môžeme vidieť z výpisu vyššie, dataset už neobsahuje žiadne N/A hodnoty.








