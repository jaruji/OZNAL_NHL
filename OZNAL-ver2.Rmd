---
title: "R Notebook"
#output: rmarkdown::github_document
output: html_notebook 
---

```{r}
#nejake kniznice
library(dplyr)
library(tidyverse)
library(data.table)
library(corrplot)
library(RColorBrewer)
library(rcompanion)
library(lawstat)
library(moments)
library(forcats)
library(car)
library(ggpubr)
```

## Dáta
V tejto sekcii bude opísaný základný zdroj dát + postup, akým sme získali náš unikátny dataset - bolo potrebné vykonať viacero krokov, ktoré zahŕňali spájanie viacerých datasetov, elimináciu niektorých atribútov, deduplikáciu a na záver vytváranie úplne nových relevantných atribútov na základe hodnôt niektorých atribútov pôvodného datasetu.

### Tabuľka game
Tabuľka obsahuje základné dáta jednotlivých zápasov. Neobsahuje však detailné informácie o tímoch alebo tímových štatistikách konkrétneho zápasu. Taktiež neobsahuje čitateľné identifikátory tímov (t.j. ich názvy, obsahuje iba ID) Pomocou atribútov game_id, away_team_id a home_team_id však dokážeme namapovať iné tabuľky tak, aby sme dostali jeden dataset so všetkými pre nás relevantnými hodnotami.

```{r}
#setwd(dir) 
path <- ('data/game.csv')
game <- fread(path)
head(game)
```

Niektoré atribúty sú z pohľadu štatistiky nezaujímavé a teda ich môžeme odstrániť pred spájaním tabuliek. Napríklad údaje o časovej zóne, alebo identifikátory štadiónov a pododobne. Pri týchto atribútoch predpokladáme, že pre naše riešenie zaujímavé žiadnym spôsobom nebudú - samozrejme, využitie by sa určite nájsť dalo, no aj vzhľadom na predpokladaný počet atribútov nemáme potrebu tieto atribúty v datasete ponechať.

```{r}
game <- subset(game, select=-c(venue_link,venue_time_zone_id, venue_time_zone_offset, venue_time_zone_tz))
head(game)
dim(game)
```
```{r}
dim(game[game$season==20192020,])
dim(subset(game, season==20192020 & type=='P'))
```

Prvotnou analýzou sme zistili, že v minulej sezóne sa odohralo približne 2500 zápasov, z čoho bolo +-10 percent (231 zápasov) v playoff. Percentuálny pomer zápasov regulárnej a vyraďovacej časti nie je vhodný pre rozdelenie na trénovací a testovací dataset (tam je odporúčaný pomer 70:30, resp. 80:20). Náš prvotný predpoklad, že môžeme dataset trénovať na regulárnej sezóne a následne testovať na zápasoch play-off teda nebude ideálny - vhodnejší bude možno prístup rozdelenia podľa sezón, kedy na zápasoch starších sezón model natrénujeme a testovať ho budeme na novšej sezóne.


Počet hier v minulej sezóne bol omnoho vyšší ako je zvykom, tak sme skontrolovali existenciu duplikátnych záznamov v tabuľke. Z nasledujúceho výpisu sme odhalili 2570 duplikátov v celej tabuľke.

```{r}
game[duplicated(game)]
```
Aby sme si overili existenciu duplikátov, tak sme si vypísali náhodnú hru z vyššie vygenerovanej tabuľky duplikátov.

```{r}
game[game$game_id==2019020369]
```

Duplikáty sme eliminovali využitím funkcie distinct, ktorá zachová jedinečné záznamy. Elimináciu duplikátov sme overili opäť použitím funkcie duplicated, ktorá vrátila 0 záznamov. Počet záznamov v tabuľke klesol o 2570, aktuálny počet záznamov je teda 23735.

```{r}
game <- distinct(game)
game[duplicated(game)]
dim(game)
```

### Tabuľka game_teams_stats

Druhá tabuľka obsahuje špecifické štatistiky tímov k jednotlivým zápasom. Problémom je, že jeden záznam obsahuje štatistiky iba jedného tímu. Teda máme pre jeden záznam zápasu z tabuľky games dva záznamy v tabuľke game_teams_stats. 

```{r}
path <- ('data/game_teams_stats.csv')
game_teams_stats <- fread(path)
head(game_teams_stats)
```

Vyhodili sme atribúty, ktoré nám nepomôžu pri štatistickom vyhodnocovaní a vypísali sme si informácie o datasete. Všimli sme si, že údajov je viac ako dva-krát viac oproti záznamom v tabuľke game. To znamená, že niektoré záznamy sú duplicitné, alebo chybné.

```{r}
game_teams_stats <- subset(game_teams_stats, select=-c(head_coach, startRinkSide, goals))
head(game_teams_stats)
dim(game_teams_stats)
```
Podľa unikátnych identifikátorov zápasov vidíme, že ich je rovnako ako v tabuľke game. To znamená, že v tabuľke game_teams_stats máme duplikáty, ktoré budeme musieť odstrániť.

```{r}
length(unique(game_teams_stats$game_id))
```
### Tabuľka team_info

Táto tabuľka obsahuje iba základné infromácie o tímoch, ktoré nesúvisia so sezónami a zápasmi. Je však potrebná pre doplnenie mien tímov k jednotlivým hrám - tým spôsobom bude možné priradenie názvov tímov k záznamom a možné prípadné overenie zmysluplnosti hodnôt atribútov podľa reálnych výsledkov napr. na NHL portáli.

```{r}
path <- ('data/team_info.csv')
team_info <- fread(path)
head(team_info)
```

Z tejto tabuľky nám stačí extrahovať atribúty team_id, podľa ktorého spojíme tabuľky a abbreviation, ktorý nám doplní skratky názvov tímov ku zápasom - plné mená tímov potrebné nie sú, ako aj franchiseID alebo link na API.

```{r}
team_info <- subset(team_info, select=-c(franchiseId, link, shortName, teamName))
head(team_info)
dim(team_info)
```

### Spájanie tabuliek
V tejto sekcii vykonáme spojenie predom opisovanej trojice tabuliek, resp. troch datasetov do jedného, finálneho datasetu. Ten bude základom pre náš projekt, pričom na ňom budeme vykonávať EDA, MEDA, štatistické učenie, dokazovanie hypotéz a podobne.


```{r}
game_teams_stats <- left_join(game_teams_stats, team_info, "team_id")
head(game_teams_stats)
dim(game_teams_stats)
```
Unikátny počet ID tímov v datasete je 37 (výpis nižšie)
```{r}
length(unique(game_teams_stats$team_id))
```
Reálny počet tímov v NHL je však 31, čiže dataset obsahuje tímy navyše - táto skutočnosť je jednoducho vysvetliteľná, keďže dataset obsahuje zápasy od sezóny 2000, v ktorej hrávali tímy ktoré v dnešnej dobe už neexistujú (napr. Atlanta Trashers). Nápodobne, niektoré dnešné tímy v minulosti ešte neexistovali (napr. Las Vegas Golden Knights).



```{r}
df_h <- game_teams_stats[(game_teams_stats$HoA == 'home'),]
head(df_h)
dim(df_h)
df_h <- distinct(df_h)
unique(df_h$HoA)
```

```{r}
df_a <- game_teams_stats[(game_teams_stats$HoA == 'away'),]
head(df_a)
dim(df_a)
df_a <- distinct(df_a)
unique(df_a$HoA)
```

```{r}
df <- left_join(df_a, df_h, "game_id", suffix = c(".away", ".home"))
head(df)
dim(df)
```

```{r}
df <- left_join(game, df, "game_id")
head(df)
dim(df)
```

```{r}
dim(df[df$season==20192020,])
dim(subset(df, season==20192020 & type=='P'))
```
```{r}
dim(df[df$season==20182019,])
dim(subset(df, season==20182019 & type=='P'))
```
```{r}
dim(df[df$season==20172018,])
dim(subset(df, season==20172018 & type=='P'))
```
```{r}
dim(df[df$season==20162017,])
dim(subset(df, season==20162017 & type=='P'))
```

```{r}
glimpse(df)
```

Následne môžeme zo spojených datasetov odstrániť nepodstatné atribúty (atribútov je aj tak veľké množstvo, čize odstránenie nie dôležitých atribútov nám uľahčí prácu s datasetom). Taktiež si vytvoríme nový atribút reprezentujúci percentuálnu úspešnost zákrokov domáceho a hosťujúceho brankára, ktorú získame ako podiel striel na bránu - počet gólov vydelené celkovým počtom striel na bránu).

```{r}
df <- subset(df, select=-c(game_id, date_time_GMT, outcome, home_rink_side_start, venue, away_team_id, home_team_id, settled_in.away, HoA.away, HoA.home))
df <- rename(df, 'settled_in' = 'settled_in.home')
df <- rename(df, 'goals.away' = 'away_goals')
df <- rename(df, 'goals.home' = 'home_goals')
df$save_percentage.home = round((df$shots.away-df$goals.away)/df$shots.away, 4)
df$save_percentage.away = round((df$shots.home-df$goals.home)/df$shots.home, 4)
head(df)
dim(df)
```
Atribúty HoA.home a Hoa.away boli redundantné, keďže informáciu o domácom a hosťujúcom tíme máme zahrnutú v atribúte team_id.home a team_id.away.

## Prieskumná analýza datasetu

Kedže cieľom práce je práca na predikčnom modeli, bude vhodné nepracovať s celým datasetom ale iba poslednými sezónami. Dôvôdom je častá obmena kádrov tímov NHL, čo môže mať za následok drasticky odlíšne výkony tímov medzi sezónami. Práca s veľkým množstvom sezón bude mať pravdepodobne za následok nízku presnosť modelu a neprehľadnosť grafov. 
Dátovú množinu sme teda zmenšili na posledných 5 sezón, čo nám poskytne presnejšie výsledky pre aktuálne pravidlá zámorského hokeja.

```{r}
df <- df[df$season >= 20152016]
print(df)
```

charakteristika dát, ich rozdelenie a identifikácia problémov (+ riešenie).

```{r}
glimpse(df)

```
V datasete máme 31 atribútov. Vyšší počet je ich najmä z dôvodu potreby štatistík o hre z pohľadu oboch tímov ktoré odohrali zápas (preto máme počet atribútov cca zdvojnásobený). V tejto sekcii práce sa budeme venovať analýze jednotlivých atribútov, resp. dvojíc  atribútov.

### Atribút season
**charakteristika:** atribút reprezentuje sezónu, v ktorej sa odohral NHL zápas. Dataset obsahuje sezóny od roku 2015-2020.

```{r}
unique(df$season)
barplot(prop.table(table(df$season)), las=2, cex.names=.8, col=rgb(0.2,0.4,0.6,0.6), ylab="%", xlab="", main="Percentuálne rozdelenie atribútu season")
mtext(text = "season", side = 1,line = 4)
table(df$season)
```
Z grafu môžeme vidieť, že dataset obsahuje 5 zvolených sezón. Rozdelenie počtu hier v sezónach je percentuálne približne rovnaké (+- 3%), pričom najmenej odohraných hier bolo v poslednej sezóne - pravdepodobne zapríčinené pandemickou situáciou. Posledná sezóna v datasete je ročník 2019/2020, keďže aktuálna sezóna 2020/2021 ešte nie je ukončená a teda nie je súčasťou datasetu.

### Atribút type
**charakteristika:** atribút reprezentuje typ odohraného zápasu. Nadobúda tri základné hodnoty:

* R - regular, označuje regulárne zápasy ktoré sa hrajú počas NHL sezóny
* P - playoff, označuje zápasy vyraďovacej časti NHL, hrajú sa na konci sezóny. Tejto časti sa zúčastňujú iba najlepšie tímy.
* A - ?, predpokladáme že exhibičné zápasy
```{r}
cat("Unikátne hodnoty: \n")
unique(df$type)
cat(" \n Percentuálny podiel: \n")
cat("R = ", (100/nrow(df))*nrow(df[df$type=='R']), "%\n")
cat("P = ", (100/nrow(df))*nrow(df[df$type=='P']), "%\n")
cat("A = ", (100/nrow(df))*nrow(df[df$type=='A']), "%\n")
cat(" \n Počet výskytov:")
table(df$type)
barplot(prop.table(table(df$type)), las=2, cex.names=.8, col=rgb(0.2,0.4,0.6,0.6), ylab="%", xlab="type", main="Percentuálne rozdelenie atribútu type")
```
Z početností jednotlivých atribútov môžeme vidieť obrovskú prevahu zápasov regulárnej časti sezóny, čo aj zodpovedá skutočnosti. Použitie regulárnej sezóny na realizáciu trénovacieho datasetu a playoff na realizáciu testovacieho datatsetu nie je vhodné, pretože percentuálny podiel 92:7 nesedí s odporúčaným pomerom 70:30, alebo 80:20. Z tohoto dôvodu bude potrebné dodatočné prerozdelenie zápasov regulárnej sezóny tak, aby bol tento pomer splnený - bude riešené neskôr v práci. Hodnotu NA nemá žiaden atribút.

Hodnotu 'A' nadobúda len 5 záznamov, v žiadnom z nich sa nejedná o zápasy tímov NHL (abbreviation = NA).
```{r}
subset(df, type=='A')
```
 V zdroji datasetu nie je vysvetlené, čo hodnota "A" v atribúte type reprezentuje. Predpokladáme, že sa jedná o exhibičné zápasy, pretože atribúty tímov nie sú namapované na žiadne NHL tímy.

### Atribúty goals.home a goals.away
**charakteristika:** atribút reprezentuje počet gólov z pohľadu domáceho a hosťovského tímu.

Nejedná sa o spojitý atribút - počet gólov môže nadobúdať iba celé hodnoty, jedná sa teda o diskrétny atribút.
Už z podstaty atribútov **goals.gome** a **goals.away** vieme povedať, že sa nebude jednať o normálne rozdelenie, ale o distribúciu naklonenú vpravo (skewed right)  - toto vieme poznamenať ešte pred vizualizáciou prostredníctvom histogramov. Taktiež bude pravdepodobne obsahovať vychýlené hodnoty, keďže sa zvyknú vyskytovať zápasy s nadmerným počtom gólov. Reálny priemer sa však zvykne pohybovať okolo hodnoty 2 góly pre tím - predpokladáme, že v datasete tomu tak bude tiež. Na začiatku si teda oba atribúty vizualizujeme prostredníctvom krabicových grafov a histogramov, aby sme mohli overiť naše iniciálne predpoklady.

```{r}
cat("Základná štatistika pre goals.home", "\n")
summary(df$goals.home)
cat("\n","Základná štatistika pre goals.away", "\n")
summary(df$goals.away)
```
Zo základnej štatistiky vieme povedať, že hodnoty sú koncentrované okolo počtu gólov 3 - konkrétne na základu priemeru a mediánu (menej citlivý na vychýlené hodnoty). Maximálny počet gólov pre domáce aj hosťujúce tímy je v oboch prípadoch 10. Podľa tretieho kvantilu = 4 vieme povedať, že hodnota 10 pôsobí vychýlene. Najvyššia koncentrácia vyzerá bude v pri hodnotách 2,3,4.

```{r}
boxplot(df$goals.home, ylab="Home goals", xlab="", main="Krabicový graf gólov domáceho tímu")
hist(df$goals.home, xlab="Home goals", main="Histogram výskytov gólov domáceho tímu")
abline(v = c(mean(df$goals.home),  median(df$goals.home)), col=c("green", "blue"), lty=c(2,3), lwd=c(3,3))
boxplot(df$goals.away, ylab="Away goals", xlab="", main="Krabicový graf gólov hosťujúceho tímu")
hist(df$goals.away, xlab="Away goals", main="Histogram výskytov gólov hosťujúceho tímu")
abline(v = c(mean(df$goals.home),  median(df$goals.home)), col=c("green", "blue"), lty=c(2,3), lwd=c(3,3))
```
Dodatočne ešte overíme, či neexistujú chýbajúce hodnoty týchto atribútov v niektorých záznamoch:
```{r}
cat("Počet záznamov kde je goals.home NA", nrow(subset(df, is.na(goals.home)==TRUE)), '\n')
cat("Počet záznamov kde je goals.away NA",nrow(subset(df, is.na(goals.away)==TRUE)),'\n')
```
Ani jeden záznam nenadobúda pri atribútoch goals.home a goals.away NA hodnoty, preto nebude potrebné riešiť voľbu stratégie dopĺňania týchto hodnôt.


Už z vizualizácií atribútov vidíme, že predpoklady boli korektné. Histogramy oboch atribútov sú veľmi podobné - obe majú distribúciu naklonenú vpravo, určite sa nebude jednať o normálne rozdelenie - z tohoto dôvodu netreba ani vykonávať test normality.
Z histogramov možno vyčítať, že domáci tím strelí v priemere viac gólov ako hosťujúci tím - zatiaľ čo pri hosťujúcich tímoch nadobúdajú záznamy najčastejšie hodnotu 0 gólov, pri domácich tímoch je maximálna frekvencia pri hodnote 2 góly. Z tejto skutočnosti môžeme vyvodiť hypotézu, že domáce prostredie môže mať reálny vplyv na priemerný počet strelených gólov, resp. vonkajšie prostredie znižuje priemerný počet strelených gólov. 
Pri krabicových grafoch možno sledovať úplnú identitu týchto grafov pre oba atribúty, čo je zaujímavý jav, keďže histogramy sú mierne odlišné. Väčšina hodnôt sa pohybuje v rozmedzí 2-4 góly, čiže náš počiatočný predpoklad bol čiastočne korektný. Vychýlené hodnoty sú v oboch prípadoch počet 8, 9 a 10 gólov. Pre overenie si tieto maximálne hodnoty pre oba atribúty vypíšeme, pričom zaujímavý bude najmä počet záznamov, ktorý tieto hodnoty nadobúda.

```{r}
subset(df, goals.home >= 8)
cat("Počet vychýlených hodnôt atribútu goals.home podľa krabicového grafu:", nrow(subset(df, goals.home >= 8)))
```


```{r}
subset(df, goals.away >= 8)
cat("Počet vychýlených hodnôt atribútu goals.away podľa krabicového grafu:", nrow(subset(df, goals.away >= 8)))
```
Z výpisov vidíme, že počet zápasov v ktorých domáci tím strelil 8 a viac gólov je 48, zatiaľ čo počet zápasov v ktorých vonkajší tím strelil 8 a viac gólov je 23 - tento fakt len podporuje hypotézu, že domáce prostredie má reálny vplyv na množstvo strelených gólov. Krabicový graf tieto hodnoty označuje ako vychýlené, no keďže obsahujú dôležité informácie a jedná sa o reálne hodnoty (nie napr. chyby senzorov), tieto hodnoty nie je vhodné odstraňovať a ani normovať, resp. zrážat na nižšiu hodnotu.

V analýze atribútu budeme pokračovat prostredníctvom QQplotu, ktorý zobrazuje odchylku od teoretického normálneho rozdelenia.
```{r}
qqnorm(df$goals.home, main="Q-Q Plot atribútu goals.home")
qqline(df$goals.home, col = "red", lwd = 2)
```
```{r}
qqnorm(df$goals.away, main="Q-Q Plot atribútu goals.away")
qqline(df$goals.away, col = "red", lwd = 2)
```


Ako už bolo spomínane v úvode analýzy týchto atribútov, nejedná sa o spojité hodnoty - táto skutočnost je viditeľná aj na grafe, kedy hodnoty atribútu **goals.home** nie sú spojité - toto správanie je očakávané, keďže počty gólov musia byť celé čisla. Z grafov môžeme vidieť, že počet gólov sa vychyľuje od teoretického normálneho rozdelenia.


```{r}
plotNormalDensity(df$goals.home, main = "Diagram hustoty atribútu goals.home")
```


```{r}
plotNormalDensity(df$goals.away, main = "Diagram hustoty atribútu goals.away")
```
Z oboch diagramov hustoty môžeme vidieť už predom spomínaný fakt - atribúty **goals.home** a **goals.away** nepochádzajú z normálneho rozdelenia - výrazne vychýlené od krivky hustoty normálneho rozdelenia sú najmä hodnoty v intervale od (1-5 gólov) na x-ovej osi. Kostrbatosť grafu spôsobuje fakt, že dáta nie sú spojité.

```{r}
plot(x=df$goals.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE,main = "Diagram rozptýlenia atribútu goals.home")
```

```{r}
plot(df$goals.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE, main = "Diagram rozptýlenia atribútu goals.away")
```
Z grafov rozptýlenia vidieť, že podobne ako bolo viditeľné ak v krabicovom grafe, vychýlené hodnoty sú pri počte gólov >=8 - vychýlenosť idnikuje menšia hustota záznamov nadobúdajúcich hodnoty atribútov **goals.home** a **goals.away** >= 8 (na grafe viditeľné ako pomerne výrazný pokles "bodiek"). Ako už však bolo spomínané, odstránenie alebo úprava týchto hodnôt by so sebou niesla riziko straty dôležitých informácií - preto bude vhodné tieto hodnoty ponechať, keďže sa jedná o reálne údaje. Z grafu nie je príliš dobre vidieť, pre aký počet gólov je najväčšia koncentrácia záznamov (príliš veľa záznamov spôsobuje nízku čitateľnosť grafu) - už z krabicového grafu však vieme, že najvyššia koncentrácia je v rozmedzí 2-4 gólov, čiže táto informácia už nie je kľúčová.


```{r}
#TU NEJAKY GRAF ESTE
```


**Zhrnutie**: atribúty **goals.home** a **goals.away** sú diskrétne atribúty, ktoré nepochádzajú z normálneho rozdelenia (viditeľné na histogramoch, QQ-plotoch a grafoch hustoty), ich distribúcia je podľa očakávaní naklonená vpravo. Z grafov rozptýlenia a krabicových grafov vidieť, že za vychýlené hodnoty možno pri oboch atribútoch považovať počty gólov väčšie rovné ako 8 - z dôvodu významnosti tejto informácie však tieto hodnoty neplánujeme nijako upravovať. Oba atribúty možno z hľadiska plánovaných hypotéz považovať za kľúčové.

### Atribúty team_id.home a team_id.away
**charakteristika:** Identifikačné číslo NHL tímu v rámci datasetu.

Aktuálne sa v NHL nachádza 31 tímov, pričom sa tento počet od sezóny 2015/2016 nezmenil. Overíme, či sa v datatsete sedí počet tímov a pozrieme sa aj na počet hier každého tímu, ktorý sa môže meniť pri účasti vo vyraďovacej fáze.

```{r}
length(table(df$team_id.home))
table(df$team_id.home)
barplot(table(df$team_id.home), las=2, cex.names=.8, xlab="Frequency", ylab="Team ID", main="Počet hier pre domáce tímy", horiz=TRUE, xlim=c(0,250), space=c(1,1,1,1), col=c("salmon2"))
table(df$team_id.away)
barplot(table(df$team_id.away), las=2, cex.names=.8, xlab="Frequency", ylab="Team ID", main="Počet hier pre hosťujúce tímy", horiz=TRUE, xlim=c(0,250), space=c(1,1,1,1), col=c("salmon2"))
```

Zistili sme, že v datasete je viac ako 31 tímov. Taktiež z grafov môžeme vidieť, že niektoré tímy odohrali iba pár zápasov. Tieto zápasy si vypíšeme nižšie. Ostatné tímy majú približne rovnaký počet zápasov ~(200-230).

```{r}
df[df$team_id.away >= 55]
```
Z výpisu môžeme vidieť, že tímy s nízkym počtom zápasov sú exhibičné tímy, ktoré sme úvadzali vyššie - nejedná sa o tímy NHL. Tieto záznamy teda bude potrebné odstrániť.

### Atribúty won.home a won.away
**charakteristika:** jedná sa o boolean atribúty, vyjadrujú ktorý tím v zápase zvíťazil. V drtivej väčšine prípadov sú opačné, t.j TRUE FALSE alebo FALSE TRUE. Môže však nastať aj situácia v ktorej majú oba hodnotu FALSE - keďže remízy v týchto sezónach neboli povolené, tieto hodnoty by sa reálne v datasete vyskytovať pri legitímnych záznamoch nemali.

```{r}
unique(df$won.home)
unique(df$won.away)
subset(df, won.home==TRUE & won.away==TRUE)
subset(df, won.home==FALSE & won.away==FALSE)
verify <- subset(df, won.home==FALSE & won.away==FALSE)
```

Výsledok zápasu TRUE TRUE nie je možný. Preto je potrebné skontrolovať, či sa v datasete tento výsledok nenachádza (ak áno je potrebné ho opraviť). Po kontrole s vysužitím funkcie unique sme zistili, že TRUE TRUE sa v datasete nachádza 0x. FALSE FALSE sa vŠak v datasete nachádza 14x - po pohľade na dáta vieme povedať, že sa nebude jednať o remízy - pre záznamy chýbajú dáta, pravdepodobne sa bude jednať o odložené alebo zrušené zápasy. Žiaden z týchto zápasov však pre naše riešenie nemá pridanú hodnotu - keďže chýbajú všetky relevantné štatistické atribúty (resp. ich hodnota je 0), tieto zápasy môžeme úplne bez problémov z datasetu pri čistení odstrániť - nestratíme totižto žiadnu štatisticky cennú informáciu.

```{r}
unique(verify$season)
```


```{r}
table(is.na(df$won.home))
table(is.na(df$won.away))
```

Atribúty won.home a won.away neobsahujú žiadne prázdne hodnoty, preto nie je potrebné voliť stratégie ich nahrádzania.

### Atribúty shots.home a shots.away
**charakteristika:** atribút reprezentuje počet striel na bránu z pohľadu domáceho a hosťovského tímu.

Pri atribútoch overíme, či neobsahujú chýbajúce hodnoty:
```{r}
cat("Počet záznamov kde je shots.home NA", nrow(subset(df, is.na(shots.home)==TRUE)), '\n')
cat("Počet záznamov kde je shots.away NA",nrow(subset(df, is.na(shots.away)==TRUE)),'\n')
```
Vidíme, že v štyroch záznamoch nadobúdajú atribúty shots.home a shots.away hodnotu NA. Na tieto záznamy sa môžeme bližšie pozrieť.

```{r}
subset(df, is.na(shots.home)==TRUE)
subset(df, is.na(shots.away)==TRUE)
```
Z výpisu vidíme, že v oboch prípadoch sa jedná o zápasy play-off medzi tímami NHL, ktoré vŠak neobsahujú žiade štatistické informácie (takmer všetko je NA) - tieto záznamy bude vhodné odstrániť, keďže neobsahujú žiadne relevantné informácie, pravdepodobne sa jedná o zrušené zápasy v play-off. Taktiež je vhodné podotknúť, že tieto 4 zápasy sú rovnaké pre oba atribúty, t.j. po ich odstránení budú odstránené NA hodnoty pre oba atribúty - bude riešené vo fázi čistenia dát.


```{r}
boxplot(df$shots.home, ylab="Home shots", xlab="", main="Krabicový graf striel na bránu domáceho tímu")
hist(df$shots.home, xlab="Home shots", main="Histogram striel na bránu domáceho tímu")
boxplot(df$shots.away, ylab="Away shots", xlab="", main="Krabicový graf striel na bránu hosťujúceho tímu")
hist(df$shots.away, xlab="Away shots", main="Histogram striel na bránu hosťujúceho tímu")
```
 
 Z histogramov možno vidieť, že distribúcia atribútov shots.home a shots.away pripomína normálnu distribúciu. Taktiež možno sledovať odlahľú hodnotu - konkrétne počet striel 0. Ako sme už zistili, jedná sa o chýbajúce záznamy, ktoré budú neskôr odstránené. Predpokladáme teda, že táto odľahlá hodnota bude po fáze čistenia dát eliminovaná. Ohľadom hodnôt atribútov vieme povedať, že aj pri **shots.home** aj **shots.away** nadobúdajú atribúty veľmi podobné hodnoty - najväčšia koncentrácia záznamov je okolo 30 striel. Pri prvom pohľade na histogram však vyzerá, že hosťujúce tímy mávajú v priemere o niečo málo viac striel na bránu ako domáce, čo je zaujímavé, keďže domáce tímy mávajú priemerne viac gólov na zápas (ako bolo opísané v analýze atribútov **goals.home** a **goals.away**).
 
Pri krabicových grafoch je zaujímavý najmä atribút **shots.home** - konkrétne pomerne výrazne odľahlá hodnota okolo 80 striel na bránu
(najbližšia druhá je okolo 60 striel). Pri atribúte **shots.away** - sú všetky "odľahlé" hodnoty združené okolo hodnoty 60 striel. Počet 80+ striel teda na prvý pohľad pôsobí podozrivo - tento záznam si vypíšeme aby sme zistili, či sa môže jednať o chybu merania. Odľahlá hodnota je taktiež hodnota 0, dôvod jej výskytu + postup riešenia sme však už riešili pri opise histogramu.

```{r}
subset(df, df$shots.home >= 80)
```
Z výpisu záznamu vidíme, že sa jedná o zápas play-off medzi Columbus Blue Jackets a Tamba Bay Lightning, kedy bol počet striel na jednej strane 88 a na druhej 63. Zápas bol taktiež ukončený v predĺžení - keďže v play-off je možný nekonečný počet predĺžení až pokiaľ nie je jasný výsledok zápasu (remíza vo vyraďovacích zápasoch nie je povolená) môžeme predpokladať, že sa jedná o zápas ktorý bol predĺžovaný viac krát. Počty striel sú teda legitímne a nejedná sa o chyby merania. Jedná sa však o veľmi unikátnu situáciu, ktorá môže potenciálne negatívne ovplyvniť výsledky predikčného modelu. Z tohoto dôvôdu je vhodné uvažovať nad normovaním tejto hodnoty.


```{r}
qqnorm(df$shots.home, main="Q-Q Plot atribútu shots.home")
qqline(df$shots.home, col = "red", lwd = 2)
```
Z QQ-plotu atribútu **shots.home** môžeme vidieť, že sa pomerne pekne drží teoretickej krivky normálneho rozdelenia. Síce sa jedná o diskrétnu celočíselnú hodnotu, graf nie je taký kostrbatý ako pri atribútoch **goals.home** a **goals.away** - je tomu tak preto, že atribút shots dosahuje širší interval hodnôt a tým pádom na grafe skoky medzi hodnotami nie je vidieť. Okolo počtu gólov 3 sa začína rozdelenie mierne odchylovať od krivky normálneho rozdelenia. Za zmienku stoja aj vychýlené hodnoty v 0 (už opísané aj zdôvodnené) a výrazne vychýlená hodnota 80 - jedná sa o reálnu hodnotu, no nad jej normalizáciou budeme uvažovať keďže situáciu, v ktorej hodnota bola nadobudnutá je možno považovať za extremálnu.

```{r}
qqnorm(df$shots.away, main="Q-Q Plot atribútu shots.away")
qqline(df$shots.away, col = "red", lwd = 2)
```
Pri QQ-plote atribútu **shots.away** vieme poznamenať v podstate to isté ako pri atribúte **shots.home**. Rozdielom však je pomerne prudšie vychýlenie od teoretickej krivky normálneho rozdelenia pre pri počte striel väčšom rovnom ako 40. Výrazne vychýlená hodnota ako v predošlom grafe tu však nie je, všetky nadobúdajú hodnoty okolo 60 (bolo viditeľné už z krabicového grafu). Vyzerá to však tak, že distribúcia normálna nebude a bude potrebná normalizácia atribútu tak, aby sme normálne rozdelenie dosiahli.

```{r}
plotNormalDensity(df$shots.home, main = "Diagram hustoty atribútu shots.home")
```

```{r}
plotNormalDensity(df$shots.away, main = "Diagram hustoty atribútu shots.away")
```
Grafy hustoty indikujú takmer ideálnu hustotu atribútov **shots.home** a **shots.away** - vyzerá to tak, že atribúty budú mať normálnu distribúciu. Z predošlých grafov však máme dôvod o tejto skutočnosti pochybovať, bude teda pravdepodobne potrebné vykonať test normality na reprezentatívnej vzorke dát o veľkosti 1000.


```{r}
plot(x=df$shots.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE,main = "Diagram rozptýlenia atribútu shots.home")
```
Diagram rozptýlenia atribútu **shots.home** indikuje primánrne zoskupenie hodnôt v intervale od 20-40 striel na bránu, rovnako ako krabicový graf. Opätovne môžeme vidieť extrémnu vychýlenosť hodnoty 88 striel na bránu. Hodnoty 0 sú chýbajúce záznamy, vyjadrovať sa k nim teda nie je potrebné.

```{r}
plot(x=df$shots.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE,main = "Diagram rozptýlenia atribútu shots.away")
```
Diagram rozptýlenia atribútu **shots.away** indikuje opäť primárne zoskupenie hodnôt v intervale od 20-40 striel na bránu, rovnako ako predošlý graf rozptýlenia. Neexistuje extrémne vychýlená hodnota, tým pádom je os Y grafu posunutá. Údaje získané z grafov však vyzerajú v oboch atribútoch veľmi podobne. 

Grafy indikujú signifikantnú podobnosť s normálnym rozdelením. Bude preto vhodné vykonať Shapiro-Wilkov test normality, pre ktorý je potrebné vybrať reprezentatívnu vzorku o veľkosti 1000.
```{r}
sample <- sample_n(df, 1000)
hist(sample$shots.home, xlab="Home shots", main="Histogram reprezentatívnej vzorky striel na bránu hosťujúceho tímu")
hist(sample$shots.away, xlab="Away shots", main="Histogram reprezentatívnej vzorky striel na bránu hosťujúceho tímu")
cat("Štatistika shots.home\n")
summary(df$shots.home)
cat("Štatistika vzorky shots.home\n")
summary(sample$shots.home)
cat("Štatistika shots.away\n")
summary(df$shots.away)
cat("Štatistika vzorky shots.away\n")
summary(sample$shots.away)
```
Zo základnej deskriptívnej štatistiky možno vidieť veľmi podobnú varianciu hodnôt vo vzorkách (dolný-horný kvantil, priemer a medián), preto ich považujeme za reprezentatívne (aj keď neobsahujú všetky extremálne hodnoty).

Následne vykonáme už predom spomínaný Shapiro-Wilkov test normality s hladinou p = 0.05.

Test normality atribútu **shots.home**:
nulová hypotéza: dáta pochádzajú z normálneho rozdelenia
```{r}
shapiro.test(sample$shots.home)
```
Keďže p < 0.05, nulovú hypotézu zamietame - dáta nepochádzajú z normálneho rozdelenia

Test normality atribútu **shots.away**:
nulová hypotéza: dáta pochádzajú z normálneho rozdelenia
```{r}
shapiro.test(sample$shots.away)
```
Keďže p < 0.05, nulovú hypotézu zamietame - dáta nepochádzajú z normálneho rozdelenia.

Test normality bol v pri oboch atribútoch zamietnutý, preto vieme, že ani jeden atribút nepochádza z normálneho rozdelenia - pravdepodobná je mierna asymteria distribúcií atribútov.

**Zhrnutie**: atribúty **shots.home** a **shots.away** sú diskrétne atribúty, ktoré nepochádzajú z normálneho rozdelenia (dokázané Shapiro-Wilkovým testom). Hodnota **shots.home** dosahuje výrazne vychýlenú hodnotu 88, pri ktorej však bola zistená jej validita (t.j. jedná sa o valídnu hodnotu a nie chybu senzora). Túto hodnotu pravdepodobne bude vhodné normalizovať napr. pomocou horného kvantilu, keďže je naozaj extremálna. Atribúty **shots.home** a **shots.away** sú na grafov veľmi podobné, dosahujú miernu asymetriu. Vychýlené hodnoty 0 sa vyskytujú v oboch atribútoch, bolo však zistené, že sa jedná o chýbajúce záznamy (zrušené/presunuté zápasy) - tie budú vyriešené pri fáze čistenia dát.


### Atribúty hits.home a hits.away
**charakteristika:** atribút obsahuje hodnoty počtu narazení domáceho a hosťujúceho tímu. Narazenia, resp. osobné súboje vznikajú počas hry a pripočítavajú sa na stranu tímu, ktorý narazenie inicioval. Preto sa hodnoty medzi súperiacimi tímami nemusia rovnať.

```{r}
summary(df$hits.home)
summary(df$hits.away)
```
Zo zhrnutia môžeme vidieť, že hodnoty môžu byť pravdivé, resp. neobsahujú čísla, ktoré by logicky nemohli nastať. Taktiež vidíme, že v štyroch záznamoch nám chýbajú hodnoty tohoto atribútu.

```{r}
df[is.na(df$hits.home)]
df[is.na(df$hits.away)]
```
Väčšina zo záznamov s chýbajúcimi hodnotami, je z jednej sezóny. Vyzerá to ako preložené, alebo zrušené zápasy a budeme sa na to musieť pozrieť.

```{r}
hist(df$hits.home, xlab="Home hits", main="Histogram hitov domáceho tímu")
hist(df$hits.away, xlab="Away hits", main="Histogram hitov hosťujúceho tímu")
```
Diagram pripomína normálne rozdelenie hodnôt, ale obsahuje niekoľko vychýlených hodnôt, ktoré mohli nastať z dôvodu dlhších zápasov, napr. predĺženia. Pre tento atribút bude vhodné vykonať Shapiro-Wilkov test normality, aby sme sa uistili, že rozdelenie normálne naozaj nebude.

```{r}
boxplot(df$hits.home,  ylab="Home hits", main="Krabicový graf hitov domáceho tímu")
boxplot(df$hits.away, ylab="Away hits", main="Krabicový graf hitov domáceho tímu")
```
Vidíme, že niektoré hodnoty sú veľmi vychýlené a mali by sme ich zmenšiť. Takéto vychýlené hodnoty nastávajú pri netradičných zápasoch, alebo derby, ktré sa konajú na zamrznutých jazerách. Preto môžeme hodnoty znížiť, alebo zmeniť na najčastejšiu hodnotu. Hodnoty ale nie sú extrémne vychýlené, v intervale medzi 50-80 je ich pomerne dosť a sú aj relatívne blízko seba).

```{r}
qqnorm(df$hits.home, pch = 1, frame = FALSE, main="QQ-plot atribútu hits.home")
qqline(df$hits.home, col = "steelblue", lwd = 2)
qqPlot(df$hits.home, main="QQ-plot atribútu hits.home")
qqnorm(df$hits.away, pch = 1, frame = FALSE, main="QQ-plot atribútu hits.away")
qqline(df$hits.away, col = "steelblue", lwd = 2)
qqPlot(df$hits.away, main="QQ-plot atribútu hits.away")
```
Z grafov môžeme vidieť, že hodnoty sa približujú normálnemu rozdeleniu, ale pri vyšších hodnotách sú odchylky vyššie. Môžeme analyzovať tieto hodnoty a skúsiť ich normalizovať.

```{r}
plot(density(na.omit(df$hits.home)), main="Graf hustoty atribútu hits.home")
plotNormalDensity(df$hits.home, main="Graf hustoty atribútu hits.home")
plot(density(na.omit(df$hits.away)), main="Graf hustoty atribútu hits.away")
plotNormalDensity(df$hits.away, main="Graf hustoty atribútu hits.away")
```
Rozdelenie hodnôt veľmi pripomína normálne rozdelenie, pričom je voči krivke posunuté. Pre tento atribút bude potrebné spraviť test normality, aby sme si boli istý o aké rozdelenie sa jedná.

```{r}
plot(df$hits.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE, main="Graf rozptýlenia atribútu hits.home")
plot(df$hits.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE, main="Graf rozptýlenia atribútu hits.away")
```
Z grafu hustoty vidíme, že hodnoty sú rozmanité, čo logicky sedí k zápasom NHL. No taktiež vidíme, že niektoré hodnoty sú veľmi riedke, hlavne najväčšie hodnoty a najmenšie. 

```{r}
sample <- sample_n(df, 1000)
hist(sample$blocked.home, xlab="Home team hits", main="Histogram reprezentatívnej vzorky atribútu hits.home")
hist(sample$blocked.away, xlab="Away team hits", main="Histogram reprezentatívnej vzorky atribútu hits.away")
cat("Štatistika hits.home\n")
summary(df$hits.home)
cat("Štatistika vzorky hits.home\n")
summary(sample$hits.home)
cat("Štatistika hits.away\n")
summary(df$hits.away)
cat("Štatistika vzorky hits.away\n")
summary(sample$hits.away)
```
 Vzorka je na základe interpretácie základnej štatistiky reprezentatívna, vykonáme test normality s hladinou p = 0.05.
 
```{r}
shapiro.test(sample$hits.home)
shapiro.test(sample$hits.away)
```
 V oboch prípadoch zamietame nulovú hypotézu, rozdelenie z ktorého pochádzajú atribúty **hits.home* a **hits.away** nie je normálne.
 
### Atribúty pim.home a pim.away
**charakteristika:** atribút hovorí o počte trestných minút pre jednotlivé tímy. Keďže sú najčastejšie vylúčenia sankciované dvoma minútami, tak sa budú párne hodnoty vyskytovať častejšie. No poznáme aj dlhšie tresty ako 2+2, 5, 5+2, alebo aj netradičné tresty. Vylúčenia do konca zápasu za nešportové správanie sa do tejto štatistiky nezarátavajú - jedná sa teda o reálnu minutáž, ktorú strávi hráč na trestnej lavici a jeho tím je tým pádom oslabený (osobné tresty neoslabujú tím počas celej dĺžky trestu).

```{r}
summary(df$pim.home)
summary(df$pim.away)
```
Zo zhodnotenia vidíme, že hodnoty sú priateľné a dávajú logicky zmysel, ale maximálne hodnoty sú veľmi vychýlené a záznamy majú chýbajúcu hodnotu pre tento atribút.  Tatkiež sa vyskytujú už známe chýbajúce 4 hodnoty (NA).

```{r}
hist(df$pim.home, xlab="Home pim", main="Histogram trestných minút domáceho tímu")
hist(df$pim.away,  xlab="Away pim", main="Histogram trestných minút hosťujúceho tímu")
```
Podľa grafu neobsahuje atribút normálne rozdelenie. Hodnoty skôr pripomínajú long-tail rozdelenie.

```{r}
boxplot(df$pim.home, ylab="Home pim", main="Krabicový graf trestných minút domáceho tímu")
boxplot(df$pim.away, ylab="Away pim", main="Krabicový graf trestných minút hosťujúceho tímu")
```
Krabicový graf nám iba potvrdil, že atribút obsahuje viacero vychýlených hodnôt, na ktoré sa budeme musieť pozrieť a navrhnúť možnú úpravu. Predbežne odporúčame normalizáciu atribútov pokiaľ sú väčšie rovné ako 60, no túto skutočnosť ešte overíme neskôr na grafe rozptylu.

```{r}
qqnorm(df$pim.home, pch = 1, frame = FALSE, main="QQ-plot atribútu pim.home")
qqline(df$pim.home, col = "steelblue", lwd = 2)
qqPlot(df$pim.home, main="QQ-plot atribútu pim.home")
qqnorm(df$pim.away, pch = 1, frame = FALSE, main="QQ-plot atribútu pim.away")
qqline(df$pim.away, col = "steelblue", lwd = 2)
qqPlot(df$pim.away, main="QQ-plot atribútu pim.away")
```
Q-Q grafy nám dokázali, že sa nejedná o normálne rozdelenie a hodnoty sa mu ani nepribližujú. Test normality teda nebude potrebný.


```{r}
plot(density(na.omit(df$pim.home)), main="Graf hustoty atribútu pim.home")
plotNormalDensity(df$pim.home, main="Graf hustoty atribútu pim.home")
plot(density(na.omit(df$pim.away)), main="Graf hustoty atribútu pim.away")
plotNormalDensity(df$pim.away, main="Graf hustoty atribútu pim.away")
```

Atribúty majú veľmi nezvyčajú hustotu rozdelenia hodnôt, čo je zapríčinené hlavne z dvôdou dvojminutových trestov. Hustota nepripomína normálne rozdelenie v podstate na žiadnom intervale, čize o normálne rozdelenie sa na základe grafov konať určite nebude.

```{r}
plot(df$pim.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE, main="Graf rozptýlenia atribútu pim.home")
plot(df$pim.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE, main="Graf rozptýlenia atribútu pim.away")
```

Graf rozptylu dokazuje teóriu, že počty trestných minút sú naozaj riedke pri hodnotách väčších ako 40. 40 minút však ešte možno považovať na "normálne" hodnoty, no 60+ sú už naozaj extrémne. Z riedkosti grafu pre oba atribúty pri y>= 60 vieme povedať, že hodnoty sú extrémne a môžeme ich znormalizovať napr. nahradením za horný kvantil (75%).

Zhrnutie: atribúty **pim.home** a **pim.away** sú spojité atribúty, ktoré pochádzajú z iného ako normálneho rozdelenia (podobné normálnemu no asymetrické). Obsahujú pomerne veľa vychýlených hodnôt najma pre hodnotu atribútov >= 60, preto bude vhodné ich normalizovať vo fáze čistenia dát. Pravdepodobne sa jednalo o vyhrotené zápasy, kedy bolo rozdaných naozaj veľa trestov. Takéto zápasy síce sú reálne, no taktiež sú veľmi zriedkavé a hrozí, že by mohli negatívne skresliť niektoré výsledky našej práce. JEdna hodnota v atribúte **pim.away** dokonca obsahuje jednu výrazne vychýlenú hodnotu (> 80).

 
### Atribúty powerPlayOpportunities.home a powerPlayOpportunities.away
**charakteristika:** atribút hovorí o gólových príležitostiach počas presilových hier. Tento atribút sa odvíja od počtu presilovkových minút a teda očakávame medzi nimi koreláciu.

```{r}
cat("Základná štatistika atribútu powerPlayOpportunities.home:\n ")
summary(df$powerPlayOpportunities.home)
cat("\nZákladná štatistika atribútu powerPlayOpportunities.away:\n ")
summary(df$powerPlayOpportunities.away)
```
Opätovne máme 4 NA hodnoty, tie však už boli opisované skôr. Väčšina dát bude zhluknutých okolo hodoty 3 pri oboch atribútoch, pričom vychýlené sú až okolo 10 až 9. Minimálna hodnota 0 je úplne valídna, pravdepodobne tím nehral v zápase žiadnu presilovku.

```{r}
boxplot(df$powerPlayOpportunities.home, xlab = "powerPlayOpportunities.home", main="Histogram atribútu powerPlayOpportunities.home")
hist(df$powerPlayOpportunities.home, ylab = "powerPlayOpportunities.home", main="Krabicový graf atribútu powerPlayOpportunities.home")
boxplot(df$powerPlayOpportunities.away, xlab = "powerPlayOpportunities.away", main="Histogram atribútu powerPlayOpportunities.home")
hist(df$powerPlayOpportunities.away, ylab = "powerPlayOpportunities.away", main="Krabicový graf atribútu powerPlayOpportunities.home")
```
Z grafov môžeme vidieť, hodnoty atribútu pripomínajú normálne rozdelenie s malým počtom vychýlených hodnôt. Tieto hodnoty nebude potrebné riešiť, keďže sú v rámci normy a tatkiež je ich veľmi malé množstvo, čize by nemali reálne skreslovať výsledky. Z hľadiska štatistiky sa pre našu prácu taktieŽ jedná o menej zaujímavý atribút, keďže na ňom neplánujeme postaviť žiadnu z pracovných hypotéz. 
 
 
### Atribúty powerPlayGoals.home a powerPlayGoals.away
**charakteristika:** atribút reprezentuje počet presilovkových gólov pre oba tímy. Presilovkové góly sú v NHL časté, ale veľké počty presilovkových góolov sú nezvyčajné. Väčšinou je úspešnosť presiloviek okolo 20%, čo znamená jeden gól z piatich presilových hier.

```{r}
boxplot(df$powerPlayGoals.home, ylab = "powerPlayGoals.home", main="Krabicový graf atribútu powerPlayGoals.home")
hist(df$powerPlayGoals.home, xlab = "powerPlayGoals.home", main="Histogram atribútu powerPlayGoals.home")
boxplot(df$powerPlayGoals.away, ylab = "powerPlayGoals.away", main="Krabicový graf atribútu powerPlayGoals.away")
hist(df$powerPlayGoals.away, xlab = "powerPlayGoals.home", main="Histogram atribútu powerPlayGoals.home")
```
Grafy nám odhalili naklonené rozdelenia vpravo s malým počtom vychýlených hodnôt. Krabicové grafy sú pre oba atribúty totožné, čo je zaujímavé. Vyskytuje sa malé množstvo vychýlených hodnôt, konkrétne pri počte gólov v presilovke = 3, 4, 5. Vykreslíme si dodatočne graf rozptýlenia aby sme lepšie zhodnotili, či sú hodnoty naozaj extremálne.

```{r}
plot(df$powerPlayGoals.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE, main="Graf rozptýlenia atribútu powerPlayGoals.home")
plot(df$powerPlayGoals.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE, main="Graf rozptýlenia atribútu powerPlayGoals.away")
```

```{r}
subset(df, powerPlayGoals.home >= 5)
subset(df, powerPlayGoals.away >= 5)
```
Nad jej normalizáciou ale uvažovať neplánujeme, keďže sa jedná o reálnu hodnotu ktorá nesie informáciu o efektívnom NHL tíme v presilovkách. Vo všetkých prípadoch sa však jedná o odliŠné tímy - Colorado, Washington, Vancouver a Tamba Bay - nebude sa pravdepodobne jednať o tím efektívny v presilovkách. Samozrejme, dodatočná analýza týchto hodnôt by bola vhodná, no vzhľadom na to, že tento atribút nepovažujeme za kľúčový z hľadiska hypotéz, sa budeme sústrediť radšej na analýzu iných atribútov.

Vieme povedať, že hodnota 5 gólov sa vyskytuje iba v pár zápasoch, preto ju môžeme považovať za vychýlenú od normy. Keďže však tento atribút neplánujeme špecificky používať pri riešení projektu, normalizáciu neplánujeme vykonávať. V prípade zmeny názoru túto skutočnosť v budúcnosti prehodnotíme.
 
### Atribúty faceOffWinPercentage.home a faceOffWinPercentage.away
**charakteristika:** atribút hovorí o percentuálnom počte vyhratých vhadzovaní. Spolu tvorí atribút pre domácich a hostí 100% vhadovaní. 

```{r}
boxplot(df$faceOffWinPercentage.home, ylab= "faceOffWinPercentage.home", main="Krabicový graf atribútu faceOffWinPercentage.home")
hist(df$faceOffWinPercentage.home, xlab="faceOffWinPercentage.home", main="Histogram atribútu faceOffWinPercentage.home")
boxplot(df$faceOffWinPercentage.away, ylab="faceOffWinPercentage.away", main="Krabicový graf atribútu faceOffWinPercentage.away")
hist(df$faceOffWinPercentage.away, xlab= "faceOffWinPercentage.away", main="Histogram atribútu faceOffWinPercentage.away")
```
Atribút sa veľmi podobá normálnemu rozdeleniu, pričom obsahuje zopár vychýlených hôdnot, ako napr. 0, ktorá logicky nedáva zmysel a budeme sa na ňu musieť pozrieť.

```{r}
subset(df, faceOffWinPercentage.home == 0)
subset(df, faceOffWinPercentage.away == 0)
```
V oboch prípadoch (pri oboch atribútoch) sa jedná o chýbajúce hodnoty záznamov s typom tbc, t.j. preložených alebo zrušených zápasov. Tieto zápasy budú v čistení odstránené, t.j. bude vyriešený problém s touto vychýlenou hodnotou. Ešte môžeme overiť, či súčet atribútov faceOff pre domáci a hosťujúci tím dávajú naozaj hodnotu 100%.

```{r}
unique(df$faceOffWinPercentage.away + df$faceOffWinPercentage.home == 100)
```
Vidíme, ze súčet pravdepodobností nie je vždy rovný 100. Tatkiež dosahuje hodnotu NA v niektorých záznamoch, ale to je očakávané keďže dáta ešte neboli vyčistené. Môžeme sa ale bližšie pozrieť na záznamy, ktoré nedosahujú súčet 100.

```{r}
subset(df, df$faceOffWinPercentage.away + df$faceOffWinPercentage.home != 100)
```
Jedná sa o našich klasických 10 nadbytočných záznamov. Zaujímavé však je, že sa tu naskytuje aj 11-ty záznam z reálneho zápasu medzi San Jose Sharks a Montreal Canadiens.
```{r}
38.8 + 61.3
```
Tento zápas presahuje maximálnu úspešnosť vhadzovaní o 0.1%. Toto sa pravdepodobne stalo kvôli zaokrúhľovaniu úspešností vhadzovaní jednotlivých tímov. Nejedná sa však o nejakú kritickú chybu, reálne to na dáta a výstup projektu nebude mať žiaden dopad a preto tento problém riešiť nebude potrebné (dalo by sa prípadne odpočítať od každej pravdepodobnosti -0.05 tak, aby bola výsledná hodnota 100).
 
### Atribúty giveaways.home a giveaways.away
**charakteristika:** atribút reprezentujúci odovzdané puky súperiacemu tímu bez súboja. Takýchto situácií sa v zápasoch vyskytuje viacero a nie sú nezvyčajným javom zápasu NHL.

```{r}
boxplot(df$giveaways.home, ylab = "giveaways.home", main="Krabicový graf atribútu giveaways.home")
hist(df$giveaways.home, xlab = "giveaways.home", main="Histogram atribútu giveaways.home")
boxplot(df$giveaways.away, ylab = "giveaways.away", main="Krabicový graf atribútu giveaways.away")
hist(df$giveaways.away, xlab = "giveaways.away", main="Histogram atribútu giveaways.away")
```
Hodnoty jemne pripomínajú normálne rozdelenie, no reálne sa bude jednať o distribúciu naklonenú vpravo. Taktiež je tam veľa vychýleých hodnôt, ktoré však nemusia znamenať chyby merania. Atribút nebudeme analyzovať podrobnejšie z dôvodu, že pre našu prácu ho nepovažujeme za kľúčový.
 
### Atribúty takeaways.home a takeaways.away
**charakteristika:** atribút, ktorý reprezentuje počet odobraných pukov súperiacemu tímu. Tento atribút nie je komplementom vyššie spomenutého atribútu odovzdania pukov.

```{r}
boxplot(df$takeaways.home, ylab = "takeaways.home", main="Krabicový graf atribútu takeaways.home")
hist(df$takeaways.home, xlab = "takeaways.home", main="Histogram atribútu takeaways.home")
boxplot(df$takeaways.away, ylab = "takeaways.away", main="Krabicový graf atribútu takeaways.away")
hist(df$takeaways.away, xlab = "takeaways.away", main="Histogram atribútu takeaways.away")
```
Na histograme môžeme vidieť, že sa jedná o distribúciu naklonenú vpravo. Taktiež je tam dosť vychýleých hodnôt, ktoré však opäť nemusia (a pravdepodobne ani nebudú) znamenať chyby merania. Atribút nebudeme analyzovať podrobnejšie z dôvodu, že pre našu prácu ho nepovažujeme za kľúčový (má maximálne len situačné využitie).

### Atribúty blocked.home a blocked.away
**charakteristika:** atribút súčtu zablokovaných striel na bránu. hráčmi, inými ako brankár. To znamená, že hráč zablokuje strelu na bránu hokejkou, korčuľou, alebo telom a puk sa vôbec nedostane k brankárovi. Zabkovania strely nie sú nezvyčajné v NHL, ale nevyskytujú sa vo veľkých počtoch, ako napr. strely na bránku.

```{r}
boxplot(df$blocked.home, ylab="blocked.home", main="Krabicový graf atribútu blocked.home")
hist(df$blocked.home, xlab="blocked.home", main="Histogram atribútu blocked.home")
boxplot(df$blocked.away, ylab="blocked.away", main="Krabicový graf atribútu blocked.away")
hist(df$blocked.away, xlab="blocked.away", main="Histogram atribútu blocked.away")
```
Hodnoty atribútu veľmi pripomínajú normálne rozdeleni, ale vidíme aj zopár vychýlených hodnôt, čo môže byť z dôvodu dlhší hier, napr. kvôli predĺženiu. Atribút **blocked.away** obsahuje jednu výrazne vychýlenú hodnotu, ktorú bude vhodné riešiť pri čistení dát. Distribúcia pripomína normálne rozdelenie, nakreslíme si QQ-plot a pozrieme sa na zhodu s krivkou teoretického normálneho rozdelenia.


```{r}
qqnorm(df$blocked.home, main="Q-Q Plot atribútu blocked.home")
qqline(df$blocked.home, col = "red", lwd = 2)
```
Atribút sa odkláňa od normálnej krivky pri hodnotách >= 20.

```{r}
qqnorm(df$blocked.away, main="Q-Q Plot atribútu blocked.away")
qqline(df$blocked.away, col = "red", lwd = 2)
```
Atribút sa odkláňa od normálnej krivky pri hodnotách >= 20. Obsahuje jednu výrazne vychýlenú hodnotu (>60). Túto hodnotu bude vhodné redukovať tak, aby nehrozilo skreslenie výsledkov. Vykonáme ešte Shapiro-Wilkov test normality aby sme sa uistili, že atribúty nepochádzajú z normálneho rozdelenia.

Grafy indikujú signifikantnú podobnosť s normálnym rozdelením. Bude preto vhodné vykonať Shapiro-Wilkov test normality, pre ktorý je potrebné vybrať reprezentatívnu vzorku o veľkosti 1000.
```{r}
sample <- sample_n(df, 1000)
hist(sample$blocked.home, xlab="Home team blocked shots", main="Histogram reprezentatívnej vzorky atribútu blocked.home")
hist(sample$blocked.away, xlab="Away team blocked shots", main="Histogram reprezentatívnej vzorky atribútu blocked.away")
cat("Štatistika blocked.home\n")
summary(df$blocked.home)
cat("Štatistika vzorky blocked.home\n")
summary(sample$blocked.home)
cat("Štatistika blocked.away\n")
summary(df$blocked.away)
cat("Štatistika vzorky blcoked.away\n")
summary(sample$blocked.away)
```
Vzorka má podobnú varianciu ako pôvodný dataset, preto na nej vykonáme test normality s hladinou p = 0.05.


```{r}
shapiro.test(sample$blocked.home)
shapiro.test(sample$blocked.away)
```
Test v oboch prípadoch zamietame, atribút nepochádza z normálneho rozdelenia. Vychýlenú hodnotu v atribúte **blocked.away** bude vhodné pri čistení dát riešiť.

### Atribúty abbreviation.home a abbreviation.away
**charakteristika:** atribút, ktoréh hodnoty obsahujú iba tri písmená a reprezentuje skratkú tímov., ktoré prosti sebe nastúpili v zápase. Pre nami vybrané sezóny bolo v NHL 31 tímov a teda má tento atribút 31 unikátnych hodnôt.

Tento atribút ma iba čisto informatívny charakter, môžeme akurát overiť či sa počet skratiek tímov reálne rovná počtu tímov patriacich do súťaže NHL (čiže 31 tímov).

```{r}
length(unique(df$abbreviation.away))
length(unique(df$abbreviation.home))
```

Zistili sme, že v oboch atribútoch je o jednu hodnotu navyše. Pozrieme sa teda na hodnoty a skúsime nájsť vinníka.
```{r}
unique(df$abbreviation.away)
```
PHI - Philadelphia Flyers

ANA - Annaheim Ducks

COL - Colorado Avalanche

WPG - Winnipeg Jets

CGY - Calgary Flames

WSH - Washington Capitals

TOR - Toronto Maple Leafs

VAN - Vancouver Canucks

CBJ - Columbus Blue Jackets

EDM - Edmonton Oilers

NYI - New York Islanders

CHI - Chicago Blackhawks

PIT - Pittsburg Penguins

TBL - Tamba Bay Lightning

BOS - Boston Bruins

NJD - New Jersey Devils

OTT - Ottawa Senators

MTL - Montreal Canadiens

LAK - Los Angeles Kings

FLA - Florida Panthers

CAR - Carolina Hurricanes

SJS - San Jose Sharks

MIN - Minnesota Wild

NYR - New York Rangers

DAL - Dallas Stars

DET - Detroit Red Wings

BUF - Buffalo Sabres

ARI - Arizone Coyotes

STL - Saint Louis Blues

NSH - Nashville Predators

VGK - Las Vegas Golden Knights

NA - hodnota ktorú nadobúda abbreviation pri type A - zápasy mimo NHL

Všetky hodnoty boli popísané a taktiež bol vysvetlený o jeden väčší počet - ten bude pri čistení dát odstránený. Tento atribút však z hľadiska štatistiky neprináša žiadnu dodatočnú hodnotu, slúži iba na priradenie zápasov k reálnym názvom tímov dodatočne ako k iba im ID-čkam.

### Atribúty settled_in
**charakteristika:** atribút, ktorý ukazuje ako skončil zápas. V NHL môže zápas skončiť viacerými spôsobmi: v riadnom hracom čase, v predĺžení, po nájazdoch (v starších sezónach), alebo z netradičných dôvodov (roztopenie ľadu, výpadok elektrického prúsu, ...).


```{r}
unique(df$settled_in)
```
Tento atribút nadobúda 3 hodnoty - REG, OT a tbc. 
REG - rozhodnutý zápas v riadnom hraciom čase
OT - zápas rozhodnutý v predĺžení
tbc - pravdepodobne zrušený zápas

Keďže si niesme istý, čo reprezentuje hodnota atribútu "tbc", vypíŠeme si záznamy ktoré ju obsahujú.

```{r}
subset(df, settled_in=='tbc')
```
V drtivej väčšine prípadov sa jedná o zrušené zápasy - vyskytujú sa tu však aj zápasy, ktorých štatistiky nadobúdajú hodnoty odlišné od 0 - vo všetkých prípadoch majú tieto zápasy však type = A, čo sme už v predošlej analýze atribútu type usúdili, že sa nejedná o valídne NHL zápasy a preto budú z datasetu pri čistení odstránené. Vieme povedať, že všetky zápasy ktoré nadobúdajú hodnotu tbc budú teda odstránené - ani jeden totižto neprináša pridanú hodnotu (0-vé hodnoty relevantných štatistík alebo zápasy mimo súťaže NHL).

```{r}
barplot(prop.table(table(df$settled_in)), las=2, cex.names=.8, col=rgb(0.2,0.4,0.6,0.6), ylab="%", xlab="settled_in", main="Percentuálne rozdelenie atribútu settled_id")

```

Z grafu vidíme, že cca 20% zápasov je ukončených mimo riadneho hracieho času (v predĺžení). Percentuálny pomer hodnoty tbc je zanedbateľný. Okolo 80% zápasov je tým pádom rozhodnutých v riadnom hracom čase. Pri párovej analýze môže byť dodatočne zaujímave pozrieť sa, koľko zápasov play-off sa končí v predĺžení oproti zápasom regulárnej sezóny (predpokladáme že v play-off bývajú zápasy vyrovnanejšie a tým pádom je častejšie po riadnom hracom čase remízový stav).

Keďže tento atribút reálne nadobúda iba 2 hodnoty, bude možné ho pri fáze transformácie dát konvertovať na binárny atribút - ten je jednoduchšie strojovo spracovateľný a je moŽné sledovať aj závislosti s inými numerickými atribútmi napr. pomocou korelácií alebo logistickej regresie.

 
### Atribúty save_percentage.home a save_percentage.away
**charakteristika:** Tento atribút reprezentuje úspešnosť brankára v precentách. Úspešnosť brankára nie je súčasťou pôvodného datasetu - atribút sme si vytvorili a údaje doplnili na základe hodnôt z iných atribútov.

```{r}
summary(df$save_percentage.home)
summary(df$save_percentage.away)
```
Hodnoty úspešnosti brankárov sme vypočítali sami a poskytujú veľmi podobné priemerné hodnoty, ako uvádza oficiálna nHL stránka. Môžeme ale vidieť, že 14 záznamov má tento atribút nevyplnený. Tento problém budeme riešiť pri čistení dát, prípadne následne môŽeme analýzu opätovne vykonať a pozrieť sa či sa niečo nezmení - aj keď vieme, že 14 záznamov je veľmi málo a na celkový výsledok analýzy pravdepodobne budú mať iba veľmi minimálny vplyv.

```{r}
hist(df$save_percentage.home, xlab="save_percentage.home", main="Histogram úspešnosti domáceho brankára")
abline(v = c(mean(df$save_percentage.home),  median(df$save_percentage.home)), col=c("green", "blue"), lty=c(2,3), lwd=c(3,3))
hist(df$save_percentage.away, xlab="save_percentage.away", main="Histogram úspešnosti hosťujúceho brankára")
abline(v = c(mean(df$save_percentage.home),  median(df$save_percentage.home)), col=c("green", "blue"), lty=c(2,3), lwd=c(3,3))
```
Graf nám ukazuje, že hodnoty netvoria normálne rozdelenie. Skôr sú naklonené vľavo s malým počtom vychýlených hodnôt (okolo hodnoty 0.6) - 60% úspešnosť zákrokov je síce naozaj nízka, no jedná sa o reálne hodnoty ktoré sa v NHL a celkovo pri hokeji zriedkavo vysknú.

```{r}
boxplot(df$save_percentage.home)
boxplot(df$save_percentage.away)
```
Vychýlené hodnoty sú zo spodného kvantilu a nie je ich veľa. Môžeme sa na ne pozrieť pri čistení dát a zhodnotiť ich úpravu, no tá bude aj vzhľadom na predošlé konštatovanie o reálnom výskyte týchto údajov veľmi nepravdepodobná - predsa len nám tieto hodnoty poskytujú dôležitú štatistickú informáciu o výkone brankárov tímov, ktorú potenciálnou úpravou nechceme stratiť.

```{r}
qqnorm(df$save_percentage.home, pch = 1, frame = FALSE, main = "QQ-plot úspešnosti zákrokov domáceho brankára")
qqline(df$save_percentage.home, col = "steelblue", lwd = 2)
qqPlot(df$save_percentage.home, main = "QQ-plot úspešnosti zákrokov domáceho brankára")
qqnorm(df$save_percentage.away, pch = 1, frame = FALSE,main = "QQ-plot úspešnosti zákrokov hosťujúceho brankára")
qqline(df$save_percentage.away, col = "steelblue", lwd = 2)
qqPlot(df$save_percentage.away, main = "QQ-plot úspešnosti zákrokov hosťujúceho brankára")
```
Grafy nám ukazujú, že sa nejedná o normálne rozdelenie, pretože vrchné a spodné hodnoty majú vysokú odchylku. Na určitom intervale síce hodnoty pripomínajú normálne rozdelenie (napr. pre **save_percentage.away** aj **save_percentage.home** interval 0.8 až cca 0.96).

```{r}
plot(density(na.omit(df$save_percentage.home)))
plotNormalDensity(df$save_percentage.home)
plot(density(na.omit(df$save_percentage.away)))
plotNormalDensity(df$save_percentage.away)
```
Grafy hustoty s krivkou normálneho rozdelenia nám ukazujp, že hodnoty sa veľmi podobajú normálnemu rozdeleniu, ale obsahujú viacero lokálnych vrcholov, ktoré sú celkom nezvyčajné.

```{r}
plot(df$save_percentage.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
plot(df$save_percentage.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
```
Graf hustoty hodnôt nám ukazuje, že medzi čístými výkonmi brankárov a inkasovaným aspoň jedným gólom je veľká medzera, čo znamená, že góly padajú aj pri menšom počte striel na bránu. Taktiež v niektorých zápasoch majú brankári veľmi majú percentuálnu úspešnosť, čo môže byť spôsobené napríklad zranením pri zákroku (alebo veľmi zlým dňom pre brankára), z ktorého padol gól. Medzera medzi 100% úspešnosťou a zvyšnými hodnotami je spôsobená aj počtom striel - pokiaľ brankár inkasuje gól a má mať percentuálnu úspešnosť veľmi blízku číslu 100, muselo by naňho v zápase byť vystrelených naozaj veľa striel - preto sa väčšinou percentuálne úspešnosti pri najlepších brankároch pohybujú "iba" okolo hodnoty 96%. 99% pravdepodobnosť je preto takmer nereálna.

Test normality nebude potrebný, keďže grafy jednoznačne ukazujú, že distribúcia atribútov **save_percentage** nebude pochádzať z normálneho rozdelenie ale z rozdelenia s distribúciou naklonenou vľavo.

```{r}
skewness(df$save_percentage.home)
skewness(df$save_percentage.away)
```
Šikmosť nie je možné vypočítať, keďźe atribút ešte obsahuje NA hodnoty. Tie budú odstranené pri čistení dát.

Zhrnutie: Atribúty **save_percentage.home** a **save_percentage.away** sú spojité atribúty reprezentujúceho percentuálnu úspešnosť brankára (vyjadrené pomocou desatin. čísla), ktoré majú distribúciu naklonenú vĺavo.


## Párová analýza

V tejto časti chceme identifikovať možné vzťahy medzi jednotlivými atribútmi prostredníctvom výpočtu korelácií, respektíve korelačnej matice.
Nakoľko niektoré atribúty obsahujú nenumerické hodnoty, pre prvotnú identifikáciu možných vzťahov medzi atribútmi použijeme iba atribúty s numerickými hodnotami. Čo sa týka nenumerických atribútov **won.home** a **won.away**, tie aktuálne obsahujú pravdivostné hodnoty TRUE alebo FALSe a teda ich môžeme zmeniť na numerické (nahradením TRUE za 1 a FALSE za 0).

```{r}
df$won.home[df$won.home == "TRUE"] <- "1"
df$won.home[df$won.home == "FALSE"] <- "0"
df$won.away[df$won.away == "TRUE"] <- "1"
df$won.away[df$won.away == "FALSE"] <- "0"
class(df$won.home) = "numeric"
class(df$won.away) = "numeric"
unique(df$won.home)
unique(df$won.away)
```

Pre vytvorenie korelačnej matice potrebujeme numerické atribúty. Vytvoríme si pomocný dataset, ktorý bude obsahovať iba numerické atribúty pôvodného datasetu.

```{r}
df_numeric <- subset(df, select=-c(type, abbreviation.away, settled_in, abbreviation.home))
sapply(df_numeric, is.numeric)
```

Z výpisu vyššie môžeme vidieť, že všetky atribúty pomocného datasetu **df_numeric** sú numerické. Môžeme vytvoriť korelačnú maticu.

```{r}
corrplot(cor(df_numeric, use="complete.obs"), type="lower", method="color", tl.col="black")
```

Z korelačnej matice môžeme vidieť, že najväčšia korelácia (záporná) je medzi atribútmi **won.home** a **won.away**, čo je pochopiteľné, pretože keď jeden tím vyhrá, druhý musí prehrať. Podobné záporné korelácie môžeme vidieť medzi atribútmi **faceOffWinPercentage.home** a **faceOffWinPercentage.away**, ktoré hovoria o vyhratých vhadzovaniach. Ďalšie korelácie sú medzi atribútmi **won.home** a **goals.home**:

```{r}
cor(df$won.home, df$goals.home)
```
```{r}
ggplot(df, aes(x=shots.home, y=goals.home, color=won.home)) + geom_point(size=1)
```


Korelácia týchto dvoch atribútov je tiež logická. Môžeme z nej vyvodiť, že čím viac gólov tím strelí, tým je väčšia šanca, že zápas vyhrá. Podobne to platí aj pre atribúty **won.away** a **goals.away**:

```{r}
cor(df$won.away, df$goals.away)
```
```{r}
ggplot(df, aes(x=shots.away, y=goals.away, color=won.away)) + geom_point(size=1)
```

Rovnako môžeme sledovať aj koreláciu medzi atribútmi **won.away** a **goals.home** alebo **won.home** a **goals.away**. V tomto prípade však budú korelácie záporné:

```{r}
cor(df$won.away, df$goals.home)
cor(df$won.home, df$goals.away)
```

Ďalšiu koreláciu môžeme pozorovať medzi atribútmi **pim.home** a **pim.away**. Atribúty hovoria o trestných minutách tímov. Určitá korelácia je pochopiteľná, pretože ak sa napríklad dvaja hráči pobijú, idú obaja na trestnú lavičku. V takomto prípade dostávajú trestné minúty oba tíma zároveň, čoho dôsledkom je zvýšená korelácia týchto atribútov. Atribúty však obsahujú N/A hodnoty, takže ich pre znázornenie korelácie budeme ignorovať.

```{r}
cor(df$pim.home, df$pim.away, use="complete.obs")
```
```{r}
ggplot(df, aes(x=pim.home, y=pim.away)) + geom_point(size=1)
```

Trestné minúty jedného tímu znamenajú presilovku druhého tímu. Z toho tiež vyplýva korelácia medzi atribútmi **pim.home** s **powerPlayOpportunities.away** a naopak **pim.away** a **powerPlayOpportunities.home**:

```{r}
cor(df$pim.home, df$powerPlayOpportunities.away, use="complete.obs")
cor(df$pim.away, df$powerPlayOpportunities.home, use="complete.obs")
```
Z vyššie uvedených korelácií medzi jednotlivými atribútmi môžeme vytvoriť určité pracovné hypotézy, ktoré budeme v ďalších fázach projektu overovať.

Vhodné by bolo zobraziť aj úspešnosť brankárov pomocou grafov, ale nie je to zatiaľ možné, pretože atribút obsahuje aj iné/nenumerické hodnoty - NaN. Tento problém plánujeme vyriešiť pri čistení dát, po ktorom môžeme vykonať novú analýzu tohoto atribútu.

### Hypotézy
Počas fázy prieskumnej analýzy sme si stanovili 5 pracovných hypotéz, ktoré môžu byť vzhľadom na dáta zaujímavé. Tieto hypotézy sú nasledovné:

1. Tím, ktorý v zápase strelí viac ako 3 góly (vrátane), pravdepodobne vyhrá.

2. Čím je väčší súhrnný počet striel na bránu, tým viac gólov padne v zápase.

3. Čím je v zápase viac hitov, tým je zápas ostrejší a tým pádom rozhodcovia udelia tímom súhrnne viac trestných minút.

4. Čím má brankár vyššiu úspešnosť zákrokov, tým s väčšou pravdepodobnosťou jeho tím vyhrá.

5. Tím, ktorý hrá v domácom prostredí strelí viac gólov v zápase ako hosťujúci tím.

Vzťahy medzi atribútmi obshiahnutými v hypotézach bolo možné vidieť už pri prieskumnej analýze jednotlivých atribútov (EDA), ako aj pri párovej analýze (MEDA). Keďže závislosti existujú, predpokladáme, že väčšina hypotéz bude postavená dobre. Tieto hypotézy budú bližšie riešené vo fázi o štatistickom učení. V prvom rade však bude potrebné dáta vyčistit a upraviť takým spôsobom, aby boli použiteľné pre dodatočnú analýzu prostredníctvom metód štatistického učenia. Niektoré atribúty bude taktiež potrebné normalizovať - napr. logaritmom, odmocninou.

#### Hypotéza 1.
Tím, ktorý v zápase strelí viac ako 3 góly (vrátane), pravdepodobne vyhrá.

Atribúty pre túto hypotézu nie sú spojité. To znamená, že nemôžeme mať polovicu góla, alebo inú desatinnú hodnotu.
**Atribúty:** goals.home, goals.away, won.home, won.away

```{r}
par(mfrow=c(2,1))
par(mar=c(0,5,3,3))
hist(df$goals.home[df$won.home == 1], main="Histogram počtu gólov podľa výsledku zápasu (home)" , ylab="Win", xlab="", ylim=c(0,1600), xlim=c(0,11) , xaxt="n", las=1 , col="slateblue1", breaks=8)
par(mar=c(5,5,0,3))
hist(df$goals.home[df$won.home == 0], main="" , ylab="Loss", xlab="Goals", ylim=c(1600,0), xlim=c(0,11), las=1 , col="tomato3"  , breaks=8)

par(mfrow=c(2,1))
par(mar=c(0,5,3,3))
hist(df$goals.away[df$won.away == 1], main="Histogram počtu gólov podľa výsledku zápasu (away)" , ylab="Win", xlab="", ylim=c(0,1600), xlim=c(0,11) , xaxt="n", las=1 , col="slateblue1", breaks=8)
par(mar=c(5,5,0,3))
hist(df$goals.away[df$won.away == 0], main="" , ylab="Loss", xlab="Goals", ylim=c(1600,0), xlim=c(0,11), las=1 , col="tomato3"  , breaks=6)
```

Z grafov môžeme vidieť, že ten zlom výhry nastáva práve pri troch góloch. Samozrejme to neznamená, že ak tím skóruje tri, alebo viac krát, tak vyhrá.

```{r}
hist(df$goals.home, xlab="goals.home", col="darkblue", main="Frekvencia počtu strelených gólov domácich")
hist(df$goals.away, breaks = 10, xlab="goals.away", col="darkred", main="Frekvencia počtu strelených gólov hosťujúcich")
hist(df$won.home, breaks = 2, main="Frekvencia počtu výhier domácich")
hist(df$won.away, breaks = 2, main="Frekvencia počtu výhier hosťujúcich")
```

Z histogramov vidíme, že domáce tímy strielajú viac gólov ako hosťujúce. Taktiež hostujúce tímy najčastejšie strelia nula gólov. Vidíme aj, že tímy, ktoré hrajú doma vyhrávajú častejšie, bez ohľadu na sterelené góly.

```{r}
shapiro_df <- sample_n(df, 5000)
skewness(shapiro_df$goals.home)
shapiro.test(shapiro_df$goals.home)
skewness(shapiro_df$goals.away)
shapiro.test(shapiro_df$goals.away)
```
Zo Shapiro-Wilkovho testu môžeme vidieť, že ani jeden z atribútov goals.home a goals.away nemá normálne rozdelenie. Pretože v oboch prípadoch je hodnota p < 0.05.

```{r}
model_glm = glm(won.home ~ goals.home, data = df, family = "binomial")
coef(model_glm)

plot(won.home ~ goals.home, data = df, 
     col = "darkred",
     main = "Logistic regression for goals.home")
abline(h = 0, lty = 3)
abline(h = 1, lty = 3)
abline(h = 0.5, lty = 2)
curve(predict(model_glm, data.frame( goals.home = x), type = "response"), add = TRUE, lwd = 3, col = "dodgerblue")
abline(v = -coef(model_glm)[1] / coef(model_glm)[2], lwd = 2)

model_glm = glm(won.away ~ goals.away, data = df, family = "binomial")
coef(model_glm)

plot(won.away ~ goals.away, data = df, 
     col = "darkred",
     main = "Logistic regression for goals.away")
abline(h = 0, lty = 3)
abline(h = 1, lty = 3)
abline(h = 0.5, lty = 2)
curve(predict(model_glm, data.frame( goals.away = x), type = "response"), add = TRUE, lwd = 3, col = "dodgerblue")
abline(v = -coef(model_glm)[1] / coef(model_glm)[2], lwd = 2)
```
Podľa regresie môžeme vidieť, že domácemu tímu stačí často streliť menej gólov na výhru, ako hosťujúcemu. Z reálneho hladiska by sme však obe čísla zaokrúhlili na celé číslo 3, pretože góly nemôžeme reprezentovať desatinnými číslami. Logistický regresný model teda potvrdzuje našu hypotézu: Tím, ktorý v zápase strelí viac ako 3 góly (vrátane), pravdepodobne vyhrá.

#### Hypotéza 2.
Čím je väčší súhrnný počet striel na bránu, tým viac gólov padne v zápase.

Pracujeme s novými atribútmi, ktoré sme si vypočítali súčtom všetkých gólov v hre a súčtom všetkých striel v hre.
**Atribúty:** shots.home, goals.home, shots.away, goals.away

```{r}
par(mfrow=c(2,1))
par(mar=c(0,5,3,3))
hist(df$goals.home, ylab="Domáci", xlab="", ylim=c(0,1550), xlim=c(0,9), xaxt="n", las=1 , col="slateblue1", breaks=8, main="Počet strelených gólov pre oba tímy")
par(mar=c(5,5,0,3))
hist(df$goals.away, main="" , ylab="Hostia", xlab="Goals", ylim=c(0,1550), xlim=c(0,9), las=1 , col="tomato3"  , breaks=8)

par(mfrow=c(2,1))
par(mar=c(0,5,3,3))
hist(df$shots.home, ylab="Domáci", xlab="", ylim=, xlim=c(0,70), xaxt="n", las=1 , col="slateblue1", breaks=8, main="Počet striel pre oba tímy")
par(mar=c(5,5,0,3))
hist(df$shots.away, main="" , ylab="Hostia", xlab="Shots", ylim=, xlim=c(0,70), las=1 , col="tomato3"  , breaks=6)
```
Vidíme, že v domácom prostredí stielajú tímy viac gólov. Viac gólov je výsledkom väčšieho počtu striel na bránku.

```{r}
hist(df$goals.home+df$goals.away, ylab=, xlab="Goals", ylim=, xlim=c(0,18), las=1 , col="slateblue1", breaks=12, main="Počet strelených gólov v hre")

hist(df$shots.home+df$shots.away, main="Počet striel v hre" , ylab=, xlab="Shots", ylim=, xlim=c(0,120), las=1 , col="tomato3"  , breaks=120)
```
```{r}
shapiro_df <- sample_n(df, 5000)
skewness(shapiro_df$shots.home+shapiro_df$shots.away)
shapiro.test(shapiro_df$shots.home+shapiro_df$shots.away)
skewness(shapiro_df$goals.home+shapiro_df$goals.away)
shapiro.test(shapiro_df$goals.home+shapiro_df$goals.away)
```
Podľa výsledkov Shapiro-Wilkovho testu nie je ani jedna z hodnôt všetkých gólov a všetkých striel v zápase s normálnym rozdelením.

```{r}
total_shots <- df$shots.home+df$shots.away
total_goals <- df$goals.home+df$goals.away
pairs(~ total_shots + total_goals, panel=function(x,y){
  points(x,y)
  abline(lm(y~x), col='red')
})
```

#### Hypotéza 3.
Čím je v zápase viac hitov, tým je zápas ostrejší a tým pádom rozhodcovia udelia tímom súhrnne viac trestných minút.

Pri tejto hypotéze pracujeme s diskrétnymi hodnotami. Taktiež sme pracovali s hodnotami súčtu atribútov.
**Atribúty:** hits.home, pim.home, hits.away, pim.away

```{r}
hist(df$hits.home+df$hits.away, ylab=, xlab="Hits", ylim=, xlim=c(0,150), las=1 , col="slateblue1", breaks=120, main="Počet osobných súbojov v hre")

hist(df$pim.home+df$pim.away, main="Počet tretných minút v hre" , ylab=, xlab="Penalty in minutes", ylim=, xlim=c(0,150), las=1 , col="tomato3"  , breaks=120)
```

```{r}
shapiro_df <- sample_n(df, 5000)
skewness(shapiro_df$hits.home+shapiro_df$hits.away)
shapiro.test(shapiro_df$hits.home+shapiro_df$hits.away)
skewness(shapiro_df$pim.home+shapiro_df$pim.away)
shapiro.test(shapiro_df$pim.home+shapiro_df$pim.away)
```
Oba testy normality nám dokázali, že ani súčet všetkých osobných súbojov v hre a ani súčet všetkých presilovkových minút nemajú normálne rozdelenia.

```{r}
total_pim <- df$pim.home+df$pim.away
total_hits <- df$hits.home+df$hits.away
pairs(~ total_pim + total_hits, panel=function(x,y){
  points(x,y)
  abline(lm(y~x), col='red')
})
```


#### Hypotéza 4.
Čím má brankár vyššiu úspešnosť zákrokov, tým s väčšou pravdepodobnosťou jeho tím vyhrá.

Atribúty save_percentage boli vypočítané ako pomer počtu zákrokov brankára a počet všetkých striel oponenta. Pri tejto hypotéze pracujeme so spojitými atribútmi - save_percentage a kategorickými atribútmi - won.
**Atribúty:** save_percentage.home, save_percentage.away, won.home, won.away

```{r}
par(mfrow=c(2,1))
par(mar=c(0,5,3,3))
hist(df$save_percentage.home[df$won.home == 1], main="Úspešnosť brankára (home)" , ylab="Win", xlab="", ylim=c(0,1500), xlim=c(0.55,1) , xaxt="n", las=1 , col="slateblue1", breaks=12)
par(mar=c(5,5,0,3))
hist(df$save_percentage.home[df$won.home == 0], main="" , ylab="Loss", xlab="Goals", ylim=c(1500,0), xlim=c(0.55,1), las=1 , col="tomato3"  , breaks=16)

par(mfrow=c(2,1))
par(mar=c(0,5,3,3))
hist(df$save_percentage.away[df$won.away == 1], main="Úspešnosť brankára (away)" , ylab="Win", xlab="", ylim=c(0,1500), xlim=c(0.55,1), xaxt="n", las=1 , col="slateblue1", breaks=12)
par(mar=c(5,5,0,3))
hist(df$save_percentage.away[df$won.away == 0], main="" , ylab="Loss", xlab="Goals", ylim=c(1500,0), xlim=c(0.55,1), las=1 , col="tomato3"  , breaks=16)
```
Z grafu vidíme, že v domácom prostredí majú brankári väčšiu úspešnosť zákrokov.

```{r}
shapiro_df <- sample_n(df, 5000)
skewness(shapiro_df$save_percentage.home)
shapiro.test(shapiro_df$save_percentage.home)
skewness(shapiro_df$save_percentage.away)
shapiro.test(shapiro_df$save_percentage.away)
```
Z testov vidíme, že atribút save_percentage nemá normálne rozdelenie, ani pri domácom, ani pri hosťujúcom tíme.

#### Hypotéza 5.
Tím, ktorý hrá v domácom prostredí strelí viac gólov v zápase ako hosťujúci tím.

**Atribúty:** goals.home, goals.away

```{r}
par(mfrow=c(2,1))
par(mar=c(0,5,3,3))
hist(df$goals.home, main="Goals" , ylab="Domáci", xlab="", ylim=c(0,1600), xlim=c(0,10), xaxt="n", las=1 , col="slateblue1", breaks=12)
par(mar=c(5,5,0,3))
hist(df$goals.away, main="" , ylab="Hostia", xlab="Goals", ylim=c(1600,0), xlim=c(0,10), las=1 , col="tomato3"  , breaks=12)
```
Už z grafu vidíme, že domáce tímy strielajú viac gólov, ako hosťujúce. Testo normality gólov sme robili vyššie a pre ani jeden z týchto atribútov nevišiel pozitívne, resp. oba atribúty nemajú normálne rozdelenie.


## Čistenie a úprava dát

V tejto kapitole sa venujeme čisteniu a úprave dát. Niektoré úpravy sme však spravili už pred analýzou. Tieto úpravy, ako napríklad deduplikáciu dát, bolo potrebné spraviť hneď na začiatku projektu, pretože sa týkali vytvárania datasetu, ktorý v projekte používame. Dataset sme vytvorili spojením 3 tabuliek. Okrem deduplikácie dát sme tiež odstránili niektoré atribúty a iné sme naopak pridali, respektíve vytvorili (ako napríklad vytvorenie atribútu úspešnosti brankára, ktorá sa počíta na základe gólov a striel oponenta).
Cieľom tejto kapitoly je, aby všetky záznamy obsahovali údaje pre všetky atribúty. Je teda potrebné odstrániť všetky N/A hodnoty.
Z analýzy atribútu **type** vieme, že náš dataset obsahuje výsledky niektorých zápasov, ktoré nespadajú do súťaže NHL. Pre začiatok sa pozrieme, aké atribúty obsahujú N/A hodnoty a následne odstránime dané zápasy, ktoré nepatria do NHL (takéto zápasy majú hodnotu atribútu **type** rovnú 'A').

V tejto sekcii sa teda sústredíme najmä na náhradu NA hodnôt, elimináciu zbytočných záznamov (bez štatistického prínosu), normalizáciu vychýlených hodnôt identifikovaných pri prieskumnej analýze a na záver transformácii formátu niektorých atribútov (z reťazcov na numerické hodnoty) prostredníctvom tzv. one-hot encoding
.
Ako prvé však odstránime vychýlenú hodnotu z atribútu **shots.home**.

```{r}
boxplot(df$shots.home, ylab="Home shots", xlab="", main="Krabicový graf striel na bránu domáceho tímu")
```
Vychýlenú hodnotu nahradíme 75% kvantilom počtu striel domácich tímov v zápasoch, ktoré sa dohrali v predĺžení.

```{r}
df$shots.home[df$shots.home > 70] = quantile(df$shots.home[df$settled_in == 'OT'], 0.75)
```

Teraz skontrolujeme, či sa vychýlená hodnota nahradila.

```{r}
boxplot(df$shots.home, ylab="Home shots", xlab="", main="Krabicový graf striel na bránu domáceho tímu")
```
Na krabicovom grafe vyššie môžeme vidieť, že sme vychýlenú hodnotu zrazili. Teraz prejdeme na odstránenie N/A hodnôt. Ako prvé zistíme, ktoré všetky atribúty obsahujú N/A hodnoty.

```{r}
cbind(lapply(lapply(df, is.na), sum))
```
Ako bolo spomenuté, niektoré zápasy napatria do súťaže NHL. Niektoré atribúty môžu obsahovať N/A hodnoty práve z tohto dôvodu. Najskôr odstránime spomínané zápasy.

```{r}
table(df$type)
df = df[!(df$type == 'A')]
table(df$type)
```
Ako môžeme vidieť z výpisu vyššie, dataset už neobsahuje žiade zápasy, ktoré by mali hodnotu atribútu **type** rovnú 'A'. Teraz sa pozrieme, či to nejakým spôsobom ovplyvnilo počet N/A hodnôt ostatných atribútov.

```{r}
cbind(lapply(lapply(df, is.na), sum))
```
Môžeme si všimnúť, že zmizli všetky N/A hodnoty atribútov **abbrevation.away** a **abbreviation.home**. Teraz začneme postupne prechádzať ostatné atribúty obsahujúce N/A hodnoty, pričom navrhneme spôsob akým ich nahradíme.

```{r}
df[is.na(df$shots.away)]
```

Z výpisu záznamov, ktoré obsahujú N/A hodnotu v atribúte **shots_away** si môžeme všimnúť, že aj ďalšie atribúty majú N/A hodnoty. Môžeme predpokladať, že všetky N/A hodnoty (okrem atribútov **save_percentage.home** a **save_percentage.away**) v našom datasete sú obsiahnuté v práve týchto 4 konkrétnych zápasoch. Vypíšeme si čísla tímov jednotlivých atribútov, ktoré obsahujú N/A hodnoty. Ak sa čísla tímov budú zhodovať, znamená to, že všetky N/A hodnoty sú obsiahnuté v spomínaných 4 zápasoch.

```{r}
df$team_id.away[is.na(df$shots.away)]
df$team_id.away[is.na(df$hits.away)]
df$team_id.away[is.na(df$pim.away)]
df$team_id.away[is.na(df$powerPlayOpportunities.away)]
df$team_id.away[is.na(df$powerPlayGoals.away)]
df$team_id.away[is.na(df$faceOffWinPercentage.away)]
df$team_id.away[is.na(df$giveaways.away)]
df$team_id.away[is.na(df$takeaways.away)]
df$team_id.away[is.na(df$blocked.away)]
df$team_id.away[is.na(df$shots.home)]
df$team_id.away[is.na(df$hits.home)]
df$team_id.away[is.na(df$pim.home)]
df$team_id.away[is.na(df$powerPlayOpportunities.home)]
df$team_id.away[is.na(df$powerPlayGoals.home)]
df$team_id.away[is.na(df$faceOffWinPercentage.home)]
df$team_id.away[is.na(df$giveaways.home)]
df$team_id.away[is.na(df$takeaways.home)]
df$team_id.away[is.na(df$blocked.home)]
```
```{r}
df$team_id.home[is.na(df$shots.away)]
df$team_id.home[is.na(df$hits.away)]
df$team_id.home[is.na(df$pim.away)]
df$team_id.home[is.na(df$powerPlayOpportunities.away)]
df$team_id.home[is.na(df$powerPlayGoals.away)]
df$team_id.home[is.na(df$faceOffWinPercentage.away)]
df$team_id.home[is.na(df$giveaways.away)]
df$team_id.home[is.na(df$takeaways.away)]
df$team_id.home[is.na(df$blocked.away)]
df$team_id.home[is.na(df$shots.home)]
df$team_id.home[is.na(df$hits.home)]
df$team_id.home[is.na(df$pim.home)]
df$team_id.home[is.na(df$powerPlayOpportunities.home)]
df$team_id.home[is.na(df$powerPlayGoals.home)]
df$team_id.home[is.na(df$faceOffWinPercentage.home)]
df$team_id.home[is.na(df$giveaways.home)]
df$team_id.home[is.na(df$takeaways.home)]
df$team_id.home[is.na(df$blocked.home)]
```
Z výpisov môžeme vidieť, že sa čísla tímov pre všetky atribúty obsahujúce N/A hodnoty opakujú. Z toho vyplýva, že všetky N/A hodnoty v našom datasete sú z práve týchto 4 konkrétnych zápasov. Tieto zápasy pre nás teda nemajú žiadny prínos, pretože im chýbajú hodnoty veľkého množstva atribútov. Z tohto dôvodu nebudeme N/A hodnoty nijakým spôsobom nahrádzať a záznamy o daných zápasoch z datesetu jednoducho vymažeme.

```{r}
df = df[!(is.na(df$shots.away))]
cbind(lapply(lapply(df, is.na), sum))
```
Ako môžeme vidieť z výpisu vyššie, po odstránení záznamov, ktoré obsahujú N/A hodnoty v atribúte **shots.away**, zmizli všetky N/A hodnoty z celého datasetu okrem atribútov **save_percentage.home** a **save_percentage.away**. Teraz skontrolujeme tieto dva atribúty.

```{r}
df[is.na(df$save_percentage.away)]
```

Z výpisu vyššie môžeme vidieť, že 10 N/A hodnôt v **save_percentage.home** je pri rovnakých zápasoch ako pri atribúte **save_percentage.away**. Tiež si môžeme všimnúť, že tieto hodnoty vznikli z dôvodu delenia nulou (pri výpočte save_percentage vyhádzame z rozdielu počtu striel a počtu gólov, pričom výsledok ešte delíme počtom striel, t. j. v prípade, že počet striel je 0, výsledkom je NaN, pretože nulou nedelíme). Tiež si môžeme všimnúť, že všetky ostatné atribúty v týchto zápasoch majú hodnotu 0. Aj keby sme nahradili save_percentage 100-percentnou úspešnosťou, nemali by nás tieto zápasy žiadnu výpovednú hodnotu. Tieto zápasy teda môžeme odstrániť.

```{r}
df = df[!(is.na(df$save_percentage.away))]
```

Po odstránení spomínaných zápasov overíme, že dataset už neobsahuje žiadne N/A hodnoty.

```{r}
cbind(lapply(lapply(df, is.na), sum))
```

Ako môžeme vidieť z výpisu vyššie, dataset už neobsahuje žiadne N/A hodnoty.

### Príprava dát pre tréningový a trénovací dataset

V rámci čistenia dát je potrebné pripraviť dataset, aby bolo možné použiť ho pre strojové učenie, zhlukovú analýzu a Bayesovú štatistiku, pričom treba dataset rozdeliť na tréningový a testovací. Aby bolo možné ho použiť pre tieto účely, je potrebné, aby mal numerické dáta.
Náš dataset obsahuje 4 nenumerické atribúty: **type**, **settled_in**, **abbreviation.home** a **abbreviation.away**. Atribúty abbreviation nie sú zo štatistického hľadiska dôležité, sú to len skratky jednotlivých tímov. Atribúty **type** a **settled_in** však hovoria o type zápasu (či bol zápas v rámci regulárnej sezóny alebo v rámci vyraďovacej časti) a či bol zápas ukončený v riadnom hracom čase alebo v predĺžení. Oba atribúty teda nadobúdajú práve dve hodnoty a môžeme ich zmeniť na numerické (0 alebo 1).
Ako prvé zmeníme atribúty **type**:

```{r}
unique(df$type)
```
Ako môžeme vidieť, atribút **type** obsahuje dve hodnoty - "R", ak bol zápas odohraný v rámci regulárnej sezóny, alebo "P", ak bol zápas odohraný v rámci vyraďovacej časti. Tento atribút môžeme nahradiť za **isPlayOff**, pričom tento atribút bude obsahovať hodnotu 0, ak bol zápas odohraný v rámci sezóny (teda pre hodnoty "R") a 1, ak bol odohraný v rámci vyraďovacej časti (teda pre hodnoty "P").

```{r}
df$isPlayOff <- ifelse(df$type == "P", 1, 0)
```

Po nahradení môžeme skontrolovať, či boli hodnoty dosadené správne.

```{r}
unique(df$isPlayOff[df$type == "R"])
unique(df$isPlayOff[df$type == "P"])
```
Môžeme vidieť, že pre hodnoty "R" sme dosadili do atribútu **isPlayOff** hodnoty 0, a pre "P" hodnoty 1. Teraz môžeme atribút **type** odstrániť.

```{r}
df <- subset(df, select=-c(type))
df
```

Podobným spôsobom odstránime aj atribút **settled_in**. Najskôr skontrolujeme, aké hodnoty nadobúda.

```{r}
unique(df$settled_in)
```
Na základe nadobúdaných hodnôt môžeme opäť vytvoriť nový atribút **isOverTime**, pričom tento atribút bude mať hodnotu 1 pre "OT" v atribúte **settled_in** a 0 pre "REG".

```{r}
df$isOverTime <- ifelse(df$settled_in == "OT", 1, 0)
```

Opäť skontrolujeme dosadenie hodnôt do nového atribútu.

```{r}
unique(df$isOverTime[df$settled_in == "REG"])
unique(df$isOverTime[df$settled_in == "OT"])
```
Hodnoty boli dosadené správne a teda môžeme atribút **settled_in** vymazať.

```{r}
df <- subset(df, select=-c(settled_in))
df
```

Keďže sme zmenili dva atribúty na numerické, môžeme opäť vykonať párovú analýzu, pretože je možné, že medzi atribútmi vznikli nové korelácie.

## Prieskumná analýza po čistení dát

### Párová analáza po čistení dát





