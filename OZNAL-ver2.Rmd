---
title: "R Notebook"
#output: rmarkdown::github_document
output: html_notebook 
---

```{r}
#nejake kniznice
library(dplyr)
library(tidyverse)
library(data.table)
library(corrplot)
library(RColorBrewer)
library(rcompanion)
library(lawstat)
library(moments)
library(forcats)
library(car)
```

## Dáta

### Tabuľka game
Tabuľka obsahuje základné dáta jednotlivých zápasov. Neobsahuje však detailné informácie o tímoch alebo tímových štatistikách konkrétneho zápasu. Dokážeme však pomocou atribútov game_id, away_team_id a home_team_id namapovať iné tabuľky tak, aby sme dostali jeden dataset so všetkými hodnotami.

```{r}
#setwd(dir) 
path <- ('data/game.csv')
game <- fread(path)
head(game)
```

Niektoré atribúty sú z pohľadu štatistiky nezaujímavé a teda ich môžeme odstrániť pred spájaním tabuliek. Napríklad údaje o časovej zóne, alebo identifikátory štadiónov a pod.

```{r}
game <- subset(game, select=-c(venue_link,venue_time_zone_id, venue_time_zone_offset, venue_time_zone_tz))
head(game)
dim(game)
```

Prvotnou analýzou sme zistili, že v minulej sezóne sa odohralo približne 2500 zápasov, z čoho bolo +-10 percent v playoff. S týmto počtom zápasov nám stačí pracovať s poslednou sezónou pri trénovaní stroja.

```{r}
dim(game[game$season==20192020,])
dim(subset(game, season==20192020 & type=='P'))
```

```{r}
#game <- game[!(outcome %like% "tbc")]
```

Počet hier v minulej sezóne bol omnoho vyšší ako je zvykom, tak sme skontrolovali existenciu duplikátnych záznamov v tabuľke. Z výpisu nižšie sme odhalili 2570 duplikátov v celej tabuľke.

```{r}
game[duplicated(game)]
```
Aby sme si overili existenciu duplikátov, tak sme si vypísali náhodnú hru z vyššie vygenerovanej tabuľky duplikátov.

```{r}
game[game$game_id==2019020369]
```

Duplikáty sme eliminovali využitím funkcie distinct, ktorá zachová jedinečné záznamy. Elimináciu duplikátov sme overili opäť použitím funkcie duplicated, ktorá vrátila 0 záznamov. Počet záznamov v tabuľke klesol o 2570, aktuálny počet záznamov je teda 23735.

```{r}
game <- distinct(game)
game[duplicated(game)]
dim(game)
```

### Tabuľka game_teams_stats

Druhá tabuľka obsahuje špecifické štatistiky tímov k jednotlivým zápasom. Problémom je, že jeden záznam obsahuje štatistiky iba jedného tímu. Teda máme pre jeden záznam zápasu z tabuľky games dva záznamy v tabuľke game_teams_stats. 

```{r}
path <- ('data/game_teams_stats.csv')
game_teams_stats <- fread(path)
head(game_teams_stats)
```

Vyhodili sme atribúty, ktoré nám nepomôžu pri štatistickom vyhodnocovaní a vypísali sme si informácie o datasete. Všimli sme si, že údajov je viac ako dva-krát viac oproti záznamom v tabuľke game. To znamená, že niektoré záznamy sú duplicitné, alebo chybné.

```{r}
game_teams_stats <- subset(game_teams_stats, select=-c(head_coach, startRinkSide, goals))
head(game_teams_stats)
dim(game_teams_stats)
```
Podľa unikátnych identifikátorov zápasov vidíme, že ich je rovnako ako v tabuľke game. To znamená, že v tabuľke game_teams_stats máme duplikáty, ktoré budeme musieť odstrániť.

```{r}
length(unique(game_teams_stats$game_id))
```
### Tabuľka team_info

Táto tabuľka obsahuje iba základné infromácie o tímoch, ktoré nesúvisia so sezónami a zápasmi. Je však potrebná pre doplnenie mien tímov k jednotlivým hrám.

```{r}
path <- ('data/team_info.csv')
team_info <- fread(path)
head(team_info)
```

Z tejto tabuľky nám stačí extrahovať atribúty team_id, podľa ktorého spojíme tabuľky a abbreviation, ktorý nám doplní skratky názvov tímov ku zápasom.

```{r}
team_info <- subset(team_info, select=-c(franchiseId, link, shortName, teamName))
head(team_info)
dim(team_info)
```

### Spájanie tabuliek



```{r}
game_teams_stats <- left_join(game_teams_stats, team_info, "team_id")
head(game_teams_stats)
dim(game_teams_stats)
```

```{r}
length(unique(game_teams_stats$team_id))
```

```{r}
df_h <- game_teams_stats[(game_teams_stats$HoA == 'home'),]
head(df_h)
dim(df_h)
df_h <- distinct(df_h)
unique(df_h$HoA)
```

```{r}
df_a <- game_teams_stats[(game_teams_stats$HoA == 'away'),]
head(df_a)
dim(df_a)
df_a <- distinct(df_a)
unique(df_a$HoA)
```

```{r}
df <- left_join(df_a, df_h, "game_id", suffix = c(".away", ".home"))
head(df)
dim(df)
```

```{r}
df <- left_join(game, df, "game_id")
head(df)
dim(df)
```

```{r}
dim(df[df$season==20192020,])
dim(subset(df, season==20192020 & type=='P'))
```
```{r}
dim(df[df$season==20182019,])
dim(subset(df, season==20182019 & type=='P'))
```
```{r}
dim(df[df$season==20172018,])
dim(subset(df, season==20172018 & type=='P'))
```
```{r}
dim(df[df$season==20162017,])
dim(subset(df, season==20162017 & type=='P'))
```

```{r}
glimpse(df)
```


```{r}
df <- subset(df, select=-c(game_id, date_time_GMT, outcome, home_rink_side_start, venue, away_team_id, home_team_id, settled_in.away, HoA.away, HoA.home))
df <- rename(df, 'settled_in' = 'settled_in.home')
df <- rename(df, 'goals.away' = 'away_goals')
df <- rename(df, 'goals.home' = 'home_goals')
df$save_percentage.home = round((df$shots.away-df$goals.away)/df$shots.away, 4)
df$save_percentage.away = round((df$shots.home-df$goals.home)/df$shots.home, 4)
head(df)
dim(df)
```
Atribúty HoA.home a Hoa.away boli redundantné, keďže informáciu o domácom a hosťujúcom tíme máme zahrnutú v atribúte team_id.home a team_id.away.

## Prieskumná analýza datasetu

Kedže cieľom práce je práca na predikčnom modeli, bude vhodné nepracovať s celým datasetom ale iba poslednými sezónami. Dôvôdom je častá obmena kádrov tímov NHL, čo môže mať za následok drasticky odlíšne výkony tímov medzi sezónami. Práca s veľkým množstvom sezón bude mať pravdepodobne za následok nízku presnosť modelu a neprehľadnosť grafov. 
Dátovú množinu sme teda zmenšili na posledných 5 sezón, čo nám poskytne presnejšie výsledky pre aktuálne pravidlá zámorského hokeja.

```{r}
df <- df[df$season >= 20152016]
print(df)
```

charakteristika dát, ich rozdelenie a identifikácia problémov (+ riešenie).

```{r}
glimpse(df)

```
V datasete máme 31 atribútov. Vyšší počet je ich najmä z dôvodu potreby štatistík o hre z pohľadu oboch tímov ktoré odohrali zápas (preto máme počet atribútov cca zdvojnásobený). V tejto sekcii práce sa budeme venovať analýze jednotlivých atribútov, resp. dvojíc  atribútov.

### Atribút season
**charakteristika:** atribút reprezentuje sezónu, v ktorej sa odohral NHL zápas. Dataset obsahuje sezóny od roku 2015-2020.

```{r}
unique(df$season)
barplot(prop.table(table(df$season)), las=2, cex.names=.8, col=rgb(0.2,0.4,0.6,0.6), ylab="%", xlab="", main="Percentuálne rozdelenie atribútu season")
mtext(text = "season", side = 1,line = 4)
table(df$season)
```
Z grafu môžeme vidieť, že dataset obsahuje 5 zvolených sezón. Rozdelenie počtu hier v sezónach je percentuálne približne rovnaké (+- 3%), pričom najmenej odohraných hier bolo v poslednej sezóne - pravdepodobne zapríčinené pandemickou situáciou. Posledná sezóna v datasete je ročník 2019/2020, keďže aktuálna sezóna 2020/2021 ešte nie je ukončená a teda nie je súčasťou datasetu.

### Atribút type
**charakteristika:** atribút reprezentuje typ odohraného zápasu. Nadobúda tri základné hodnoty:

* R - regular, označuje regulárne zápasy ktoré sa hrajú počas NHL sezóny
* P - playoff, označuje zápasy vyraďovacej časti NHL, hrajú sa na konci sezóny. Tejto časti sa zúčastňujú iba najlepšie tímy.
* A - ?
```{r}
cat("Unikátne hodnoty: \n")
unique(df$type)
cat(" \n Percentuálny podiel: \n")
cat("R = ", (100/nrow(df))*nrow(df[df$type=='R']), "%\n")
cat("P = ", (100/nrow(df))*nrow(df[df$type=='P']), "%\n")
cat("A = ", (100/nrow(df))*nrow(df[df$type=='A']), "%\n")
cat(" \n Počet výskytov:")
table(df$type)
barplot(prop.table(table(df$type)), las=2, cex.names=.8, col=rgb(0.2,0.4,0.6,0.6), ylab="%", xlab="type", main="Percentuálne rozdelenie atribútu type")
```
Z početností jednotlivých atribútov môžeme vidieť obrovskú prevahu zápasov regulárnej časti sezóny, čo aj zodpovedá skutočnosti. Použitie regulárnej sezóny na realizáciu trénovacieho datasetu a playoff na realizáciu testovacieho datatsetu nie je vhodné, pretože percentuálny podiel 92:7 nesedí s odporúčaným pomerom 70:30, alebo 80:20. Z tohoto dôvodu bude potrebné dodatočné prerozdelenie zápasov regulárnej sezóny tak, aby bol tento pomer splnený - bude riešené neskôr v práci. Hodnotu NA nemá žiaden atribút.

Hodnotu 'A' nadobúda len 5 záznamov, v žiadnom z nich sa nejedná o zápasy tímov NHL (abbreviation = NA).
```{r}
subset(df, type=='A')
```
 V zdroji datasetu nie je vysvetlené, čo hodnota "A" v atribúte type reprezentuje. Predpokladáme, že sa jedná o exhibičné zápasy, pretože atribúty tímov nie sú namapované na žiadne NHL tímy.
 
### Atribúty goals.home a goals.away
**charakteristika:** atribút reprezentuje počet gólov z pohľadu domáceho a hosťovského tímu.

```{r}
boxplot(df$goals.home, ylab="Home goals", xlab="", main="Krabicový graf gólov domáceho tímu")
hist(df$goals.home, xlab="Home goals", main="Histogram výskytov gólov domáceho tímu")
boxplot(df$goals.away, ylab="Away goals", xlab="", main="Krabicový graf gólov hosťujúceho tímu")
hist(df$goals.away, xlab="Away goals", main="Histogram výskytov gólov hosťujúceho tímu")
```
 
### Atribúty team_id.home a team_id.away
**charakteristika:** Identifikačné číslo NHL tímu v rámci datasetu.

Aktuálne sa v NHL nachádza 31 tímov, pričom sa tento počet od sezóny 2015/2016 nezmenil. Overíme, či sa v datatsete sedí počet tímov a pozrieme sa aj na počet hier každého tímu, ktorý sa môže meniť pri účasti vo vyraďovacej fáze.

```{r}
length(table(df$team_id.home))
table(df$team_id.home)
barplot(table(df$team_id.home), las=2, cex.names=.8, xlab="Frequency", ylab="Team ID", main="Počet hier pre domáce tímy", horiz=TRUE, xlim=c(0,250), space=c(1,1,1,1), col=c("salmon2"))
table(df$team_id.away)
barplot(table(df$team_id.away), las=2, cex.names=.8, xlab="Frequency", ylab="Team ID", main="Počet hier pre hosťujúce tímy", horiz=TRUE, xlim=c(0,250), space=c(1,1,1,1), col=c("salmon2"))
```

Zistili sme, že v datasete je viac ako 31 tímov. Taktiež z grafov môžeme vidieť, že niektoré tímy odohrali iba pár zápasov. Tieto zápasy si vypíšeme nižšie. Ostatné tímy majú približne rovnaký počet zápasov ~(200-230).

```{r}
df[df$team_id.away >= 55]
```
Z výpisu môžeme vidieť, že tímy s nízkym počtom zápasov sú exhibičné tímy, ktoré sme úvadzali vyššie - nejedná sa o tímy NHL.

### Atribúty won.home a won.away
**charakteristika:** jedná sa o boolean atribúty, vyjadrujú ktorý tím v zápase zvíťazil. V drtivej väčšine prípadov sú opačné, t.j TRUE FALSE alebo FALSE TRUE. Môže však nastať aj situácia v ktorej majú oba hodnotu FALSE.

Výsledok zápasu TRUE TRUE nie je možný. Preto je potrebné skontrolovať, či sa v datasete tento výsledok nenachádza (ak áno je potrebné ho opraviť). Po kontrole s vysužitím funkcie unique sme zistili, že TRUE TRUE sa v datasete nachádza 0x. FALSE FALSE sa vŠak v datasete nachádza 642x - jedná sa o remízy - tie boli v NHL zrušené, skontrolovať si to môžeme vypísaním unikátnych sezón v týchto 642 prípadoch.

```{r}
unique(df$won.home)
unique(df$won.away)
subset(df, won.home==TRUE & won.away==TRUE)
subset(df, won.home==FALSE & won.away==FALSE)
verify <- subset(df, won.home==FALSE & won.away==FALSE)
```
 
 Z výpisu môžeme vidieť, že remízy boli naposledy v sezóne 2017/2018.

```{r}
unique(verify$season)
```


```{r}
table(is.na(df$won.home))
table(is.na(df$won.away))
```

Atribúty won.home a won.away neobsahujú žiadne prázdne hodnoty, preto nie je potrebné volenie stratégie ich nahrádzania.

### Atribúty shots.home a shots.away
**charakteristika:** atribút reprezentuje počet striel na bránu z pohľadu domáceho a hosťovského tímu.

```{r}
boxplot(df$shots.home)
hist(df$shots.home)
boxplot(df$shots.away)
hist(df$shots.away)
```
 
 Z histogramov možno vidieť, že atribúty shots majú normálnu distribúciu.
```{r}
table(is.na(df$shots.home))
table(is.na(df$shots.away))
```
Keď sa bližsie pozrieme na výsledok funkcie is.na(), môžeme vidieť, že oba atribúty shots (home aj away) obsahujú prázdne hodnoty v 4 záznamoch. Tie je potrebné v rámci čistenia dát odstrániť, resp. nahradiť. Vhodnou metódou môže byť napr. nahradenie priemernou hodnotou striel na bránu z ostatných zápasov tímu v sezóne.


### Atribúty hits.home a hits.away
**charakteristika:** atribút obsahuje hodnoty počtu narazení domáceho a hosťujúceho tímu. Narazenia, resp. osobné súboje vznikajú počas hry a pripočítavajú sa na stranu tímu, ktorý narazenie inicioval. Preto sa hodnoty medzi súperiacimi tímami nemusia rovnať.

```{r}
summary(df$hits.home)
summary(df$hits.away)
```
Zo zhrnutia môžeme vidieť, že hodnoty môžu byť pravdivé, resp. neobsahujú čísla, ktoré by logicky nemohli nastať. Taktiež vidíme, že v štyroch záznamoch nám chýbajú hodnoty tohoto atribútu.

```{r}
df[is.na(df$hits.home)]
df[is.na(df$hits.away)]
```
Väčšina zo záznamov s chýbajúcimi hodnotami, je z jednej sezóny. Vyzerá to ako preložené, alebo zrušené zápasy a budeme sa na to musieť pozrieť.

```{r}
hist(df$hits.home)
hist(df$hits.away)
```
Diagram pripomína normálne rozdelenie hodnôt, ale obsahuje niekoľko vychýlených hodnôt, ktoré mohli nastať z dôvodu dlhších zápasov, napr. predĺženia.

```{r}
boxplot(df$hits.home)
boxplot(df$hits.away)
```
Vidíme, že niektoré hodnoty sú veľmi vychýlené a mali by sme ich zmenšiť. Takéto vychýlené hodnoty nastávajú pri netradičných zápasoch, alebo derby, ktré sa konajú na zamrznutých jazerách. Preto môžeme hodnoty znížiť, alebo zmeniť na najčastejšiu hodnotu.

```{r}
qqnorm(df$hits.home, pch = 1, frame = FALSE)
qqline(df$hits.home, col = "steelblue", lwd = 2)
qqPlot(df$hits.home)
qqnorm(df$hits.away, pch = 1, frame = FALSE)
qqline(df$hits.away, col = "steelblue", lwd = 2)
qqPlot(df$hits.away)
```
Z grafov môžeme vidieť, že hodnoty sa približujú normálnemu rozdeleniu, ale pri vyšších hodnotách sú odchylky vyššie. Môžeme analyzovať tieto hodnoty a skúsiť ich normalizovať.

```{r}
plot(density(na.omit(df$hits.home)))
plotNormalDensity(df$hits.home)
plot(density(na.omit(df$hits.away)))
plotNormalDensity(df$hits.away)
```
Rozdelenie hodnôt veľmi pripomína normálne rozdelenie, pričom je voči krivke posunuté. PRe tento atribút bude potrebné spraviť test normality, aby sme si boli istý o aké rozdelenie sa jedná.

```{r}
plot(df$hits.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
plot(df$hits.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
```
Z grafu hustoty vidíme, že hodnoty sú rozmanité, čo logicky sedí k zápasom NHL. No taktiež vidíme, že niektoré hodnoty sú veľmi riedke, hlavne najväčšie hodnoty a najmenšie. 
 
### Atribúty pim.home a pim.away
**charakteristika:** atribút hovorí o počte trestných minút pre jednotlivé tímy. Keďže sú najčastejšie vylúčenia sankciované dvoma minútami, tak sa budú párne hodnoty vyskytovať častejšie. No poznáme aj dlhšie tresty ako 2+2, 5, 5+2, alebo aj netradičné tresty. Vylúčenia do konca zápasu za nešportové správanie sa do tejto štatistiky nezarátavajú.

```{r}
summary(df$pim.home)
summary(df$pim.away)
```
Zo zhodnotenia vidíme, že hodnoty sú priateľné a dávajú logicky zmysel, ale maximálne hodnoty sú veľmi vychýlené a záznamy majú chýbajúcu hodnotu pre tento atribút. 

```{r}
hist(df$pim.home)
hist(df$pim.away)
```
Podľa grafu neobsahuje atribút normálne rozdelenie. Hodnoty skôr pripomínajú long-tail rozdelenie.

```{r}
boxplot(df$pim.home)
boxplot(df$pim.away)
```
Krabicový graf nám iba potvrdil, že atribút obsahuje viacero vychýlených hodnôt, na ktoré sa budeme musieť pozrieť a navrhnúť možnú úpravu.

```{r}
qqnorm(df$pim.home, pch = 1, frame = FALSE)
qqline(df$pim.home, col = "steelblue", lwd = 2)
qqPlot(df$pim.home)
qqnorm(df$pim.away, pch = 1, frame = FALSE)
qqline(df$pim.away, col = "steelblue", lwd = 2)
qqPlot(df$pim.away)
```
Q-Q grafy nám dokázali, že sa nejedná o normálne rozdelenie a hodnoty sa mu ani nepribližujú.


```{r}
plot(density(na.omit(df$pim.home)))
plotNormalDensity(df$pim.home)
plot(density(na.omit(df$pim.away)))
plotNormalDensity(df$pim.away)
plot(df$pim.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
plot(df$pim.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
```
Atribút má veľmi nezvyčajú hustotu rozdelenia hodnôt, čo je zapríčinené hlavne z dvôdou dvojminutových trestov.

 
### Atribúty powerPlayOpportunities.home a powerPlayOpportunities.away
**charakteristika:** atribút hovorí o gólových príležitostiach počas presilových hier. Tento atribút sa odvíja od počtu presilovkových minút a teda očakávame medzi nimi koreláciu.

```{r}
boxplot(df$powerPlayOpportunities.home)
hist(df$powerPlayOpportunities.home)
boxplot(df$powerPlayOpportunities.away)
hist(df$powerPlayOpportunities.away)
```
Z grafov môžeme vidieť, hodnoty atribútu pripomínajú normálne rozdelenie s malým počtom vychýlených hodnôt. 
 
 
### Atribúty powerPlayGoals.home a powerPlayGoals.away
**charakteristika:** atribút reprezentuje počet presilovkových gólov pre oba tímy. Presilovkové góly sú v NHL časté, ale veľké počty presilovkových góolov sú nezvyčajné. Väčšinou je úspešnosť presiloviek okolo 20%, čo znamená jeden gól z piatich presilových hier.

```{r}
boxplot(df$powerPlayGoals.home)
hist(df$powerPlayGoals.home)
boxplot(df$powerPlayGoals.away)
hist(df$powerPlayGoals.away)
```
Grafy nám odhalili naklonené rozdelenia s malým počtom vychýlených hodnôt, ktoré môžeme neskôr analyzovať.
 
### Atribúty faceOffWinPercentage.home a faceOffWinPercentage.away
**charakteristika:** atribút hovorí o percentuálnom počte vyhratých vhadzovaní. Spolu tvorí atribút pre domácich a hostí 100% vhadovaní. 

```{r}
boxplot(df$faceOffWinPercentage.home)
hist(df$faceOffWinPercentage.home)
boxplot(df$faceOffWinPercentage.away)
hist(df$faceOffWinPercentage.away)
```
Atribút sa veľmi podobá normálnemu rozdeleniu, pričom obsahuje zopár vychýlených hôdnot, ako napr. 0, ktorá logicky nedáva zmysel a budeme sa na ňu musieť pozrieť.
 
### Atribúty giveaways.home a giveaways.away
**charakteristika:** atribút reprezentujúci odovzdané puky súperiacemu tímu bez súboja. Takýchto situácií sa v zápasoch vyskytuje viacero a nie sú nezvyčajným javom zápasu NHL.

```{r}
boxplot(df$giveaways.home)
hist(df$giveaways.home)
boxplot(df$giveaways.away)
hist(df$giveaways.away)
```
Hodnoty jemne pripomínajú normálne rozdelenie, ale je tam veľa vychýleých hodnôt, ktoré nemusia znamenať chyby merania.
 
### Atribúty takeaways.home a takeaways.away
**charakteristika:** atribút, ktorý reprezentuje počet odobraných pukov súperiacemu tímu. Tento atribút nie je komplementom vyššie spomenutého atribútu odovzdania pukov.

```{r}
boxplot(df$takeaways.home)
hist(df$takeaways.home)
boxplot(df$takeaways.away)
hist(df$takeaways.away)
```
 
### Atribúty blocked.home a blocked.away
**charakteristika:** atribút súčtu zablokovaných striel na bránu. hráčmi, inými ako brankár. To znamená, že hráč zablokuje strelu na bránu hokejkou, korčuľou, alebo telom a puk sa vôbec nedostane k brankárovi. Zabkovania strely nie sú nezvyčajné v NHL, ale nevyskytujú sa vo veľkých počtoch, ako napr. strely na bránku.

```{r}
boxplot(df$blocked.home)
hist(df$blocked.home)
boxplot(df$blocked.away)
hist(df$blocked.away)
```
Hodnoty atribútu veľmi pripomínajú normálne rozdeleni, ale vidíme aj zopár vychýlených hodnôt, čo môže byť z dôvodu dlhší hier, napr. kvôli predĺženiu.
 
### Atribúty abbreviation.home a abbreviation.away
**charakteristika:** atribút, ktoréh hodnoty obsahujú iba tri písmená a reprezentuje skratkú tímov., ktoré prosti sebe nastúpili v zápase. Pre nami vybrané sezóny bolo v NHL 31 tímov a teda má tento atribút 31 unikátnych hodnôt.


### Atribúty settled_in.home a settled_in.away
**charakteristika:** atribút, ktorý ukazuje ako skončil zápas. V NHL môže zápas skončiť viacerými spôsobmi: v riadnom hracom čase, v predĺžení, po nájazdoch (v starších sezónach), alebo z netradičných dôvodov (roztopenie ľadu, výpadok elektrického prúsu, ...).

 
### Atribúty save_percentage.home a save_percentage.away
**charakteristika:** Tento atribút reprezentuje úspešnosť brankára v precentách. Úspešnosť brankára nie je súčasťou pôvodného datasetu - atribút sme si vytvorili a údaje doplnili na základe hodnôt z iných atribútov.

```{r}
summary(df$save_percentage.home)
summary(df$save_percentage.away)
```
Hodnoty úspešnosti brankárov sme vypočítali sami a poskytujú veľmi podobné priemerné hodnoty, ako uvádza oficiálna nHL stránka. Môžeme ale vidieť, že 14 záznamov má tento atribút nevyplnený.

```{r}
hist(df$save_percentage.home)
hist(df$save_percentage.away)
```
Graf nám ukazuje, že hodnoty netvoria normálne rozdelenie. Skôr sú naklonené napravo s malým počtom vychýlených hodnôt.

```{r}
boxplot(df$save_percentage.home)
boxplot(df$save_percentage.away)
```
Vychýlené hodnoty sú zo spodného kvantilu a nie je ich veľa. Môžeme sa na ne pozrieť a zhodnotiť ich úpravu.

```{r}
qqnorm(df$save_percentage.home, pch = 1, frame = FALSE)
qqline(df$save_percentage.home, col = "steelblue", lwd = 2)
qqPlot(df$save_percentage.home)
qqnorm(df$save_percentage.away, pch = 1, frame = FALSE)
qqline(df$save_percentage.away, col = "steelblue", lwd = 2)
qqPlot(df$save_percentage.away)
```
Grafy nám ukazujú, že sa nejedná o normálne rozdelenie, pretože vrchné a spodné hodnoty majú vysokú odchylku.

```{r}
plot(density(na.omit(df$save_percentage.home)))
plotNormalDensity(df$save_percentage.home)
plot(density(na.omit(df$save_percentage.away)))
plotNormalDensity(df$save_percentage.away)
```
Grafy hustoty s krivkou normálneho rozdelenia nám ukazujp, že hodnoty sa veľmi podobajú normálnemu rozdeleniu, ale obsahujú viacero lokálnych vrcholov, ktoré sú celkom nezvyčajné.

```{r}
plot(df$save_percentage.home, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
plot(df$save_percentage.away, pch = 21, bg = "lightgray", col = "black", cex = 0.5, frame = FALSE)
```
Graf hustoty hodnôt nám ukazuje, že medzi čístými výkonmi brankárov a inkasovaným aspoň jedným gólom je veľká medzera, čo znamená, že góly padajú aj pri menšom počte striel na bránu. Taktiež v niektorých zápasoch majú brankári veľmi majú percentuálnu úspešnosť, čo môže byť spôsobené zranením pri zákroku, z ktorého padol gól.

 

## Párová analýza

V tejto časti chceme identifikovať možné vzťahy medzi jednotlivými atribútmi prostredníctvom výpočtu korelácií, respektíve korelačnej matice.
Nakoľko niektoré atribúty obsahujú nenumerické hodnoty, pre prvotnú identifikáciu možných vzťahov medzi atribútmi použijeme iba atribúty s numerickými hodnotami. Čo sa týka nenumerických atribútov **won.home** a **won.away**, tie aktuálne obsahujú pravdivostné hodnoty TRUE alebo FALSe a teda ich môžeme zmeniť na numerické (nahradením TRUE za 1 a FALSE za 0).

```{r}
df$won.home[df$won.home == "TRUE"] <- "1"
df$won.home[df$won.home == "FALSE"] <- "0"
df$won.away[df$won.away == "TRUE"] <- "1"
df$won.away[df$won.away == "FALSE"] <- "0"
class(df$won.home) = "numeric"
class(df$won.away) = "numeric"
unique(df$won.home)
unique(df$won.away)
```

Pre vytvorenie korelačnej matice potrebujeme numerické atribúty. Vytvoríme si pomocný dataset, ktorý bude obsahovať iba numerické atribúty pôvodného datasetu.

```{r}
df_numeric <- subset(df, select=-c(type, abbreviation.away, settled_in, abbreviation.home))
sapply(df_numeric, is.numeric)
```

Z výpisu vyššie môžeme vidieť, že všetky atribúty pomocného datasetu **df_numeric** sú numerické. Môžeme vytvoriť korelačnú maticu.

```{r}
corrplot(cor(df_numeric, use="complete.obs"), type="lower", method="color", tl.col="black")
```

Z korelačnej matice môžeme vidieť, že najväčšia korelácia (záporná) je medzi atribútmi **won.home** a **won.away**, čo je pochopiteľné, pretože keď jeden tím vyhrá, druhý musí prehrať. Podobné záporné korelácie môžeme vidieť medzi atribútmi **faceOffWinPercentage.home** a **faceOffWinPercentage.away**, ktoré hovoria o vyhratých vhadzovaniach. Ďalšie korelácie sú medzi atribútmi:

```{r}
cor(df$won.home, df$goals.home)
```
Korelácia týchto dvoch atribútov je tiež logická. Môžeme z nej vyvodiť, že čím viac gólov tím strelí, tým je väčšia šanca, že zápas vyhrá. Podobne to platí aj pre atribúty **won.away** a **goals.away**:

```{r}
cor(df$won.away, df$goals.away)
```
Rovnako môžeme sledovať aj koreláciu medzi atribútmi **won.away** a **goals.home** alebo **won.home** a **goals.away**. V tomto prípade však budú korelácie záporné:

```{r}
cor(df$won.away, df$goals.home)
cor(df$won.home, df$goals.away)
```
Ďalšiu koreláciu môžeme pozorovať medzi atribútmi **pim.home** a **pim.away**. Atribúty hovoria o trestných minutách tímov. Určitá korelácia je pochopiteľná, pretože ak sa napríklad dvaja hráči pobijú, idú obaja na trestnú lavičku. V takomto prípade dostávajú trestné minúty oba tíma zároveň, čoho dôsledkom je zvýšená korelácia týchto atribútov. Atribúty však obsahujú N/A hodnoty, takže ich pre znázornenie korelácie budeme ignorovať.

```{r}
cor(df$pim.home, df$pim.away, use="complete.obs")
```
Trestné minúty jedného tímu znamenajú presilovku druhého tímu. Z toho tiež vyplýva korelácia medzi atribútmi **pim.home** s **powerPlayOpportunities.away** a naopak **pim.away** a **powerPlayOpportunities.home**:

```{r}
cor(df$pim.home, df$powerPlayOpportunities.away, use="complete.obs")
cor(df$pim.away, df$powerPlayOpportunities.home, use="complete.obs")
```
Z vyššie uvedených korelácií medzi jednotlivými atribútmi môžeme vytvoriť určié hypotézy, ktoré budeme v ďalších fázach projektu overovať:

### Hypotézy



## Čistenie a úprava dát

V tejto kapitole sa venujeme čisteniu a úprave dát. Niektoré úpravy sme však spravili už pred analýzou. Tieto úpravy, ako napríklad deduplikáciu dát, bolo potrebné spraviť hneď na začiatku projektu, pretože sa týkali vytvárania datasetu, ktorý v projekte používame. Dataset sme vytvorili spojením 3 tabuliek. Okrem deduplikácie dát sme tiež odstránili niektoré atribúty a iné sme naopak pridali, respektíve vytvorili (ako napríklad vytvorenie atribútu úspešnosti brankára, ktorá sa počíta na základe gólov a striel oponenta).
Cieľom tejto kapitoly je, aby všetky záznamy obsahovali údaje pre všetky atribúty. Je teda potrebné odstrániť všetky N/A hodnoty.
Z analýzy atribútu **type** vieme, že náš dataset obsahuje výsledky niektorých zápasov, ktoré nespadajú do súťaže NHL. Pre začiatok sa pozrieme, aké atribúty obsahujú N/A hodnoty a následne odstránime dané zápasy, ktoré nepatria do NHL (takéto zápasy majú hodnotu atribútu **type** rovnú 'A').

```{r}
cbind(lapply(lapply(df, is.na), sum))
```
Teraz môžeme odstrániť spomínané zápasy, ktoré nepatria pod NHL.

```{r}
table(df$type)
df = df[!(df$type == 'A')]
table(df$type)
```
Ako môžeme vidieť z výpisu vyššie, dataset už neobsahuje žiade zápasy, ktoré by mali hodnotu atribútu **type** rovnú 'A'. Teraz sa pozrieme, či to nejakým spôsobom ovplyvnilo počet N/A hodnôt ostatných atribútov.

```{r}
cbind(lapply(lapply(df, is.na), sum))
```
Môžeme si všimnúť, že zmizli všetky N/A hodnoty atribútov **abbrevation.away** a **abbreviation.home**. Teraz začneme postupne prechádzať ostatné atribúty obsahujúce N/A hodnoty, pričom navrhneme spôsob akým ich nahradíme.

```{r}
df[is.na(df$shots.away)]
```

Z výpisu záznamov, ktoré obsahujú N/A hodnotu v atribúte **shots_away** si môžeme všimnúť, že aj ďalšie atribúty majú N/A hodnoty. Môžeme predpokladať, že všetky N/A hodnoty v našom datasete sú obsiahnuté v práve týchto 4 konkrétnych zápasoch. Vypíšeme si čísla tímov jednotlivých atribútov, ktoré obsahujú N/A hodnoty. Ak sa čísla tímov budú zhodovať, znamená to, že všetky N/A hodnoty sú obsiahnuté v spomínaných 4 zápasoch.

```{r}
df$team_id.away[is.na(df$shots.away)]
df$team_id.away[is.na(df$hits.away)]
df$team_id.away[is.na(df$pim.away)]
df$team_id.away[is.na(df$powerPlayOpportunities.away)]
df$team_id.away[is.na(df$powerPlayGoals.away)]
df$team_id.away[is.na(df$faceOffWinPercentage.away)]
df$team_id.away[is.na(df$giveaways.away)]
df$team_id.away[is.na(df$takeaways.away)]
df$team_id.away[is.na(df$blocked.away)]
df$team_id.away[is.na(df$shots.home)]
df$team_id.away[is.na(df$hits.home)]
df$team_id.away[is.na(df$pim.home)]
df$team_id.away[is.na(df$powerPlayOpportunities.home)]
df$team_id.away[is.na(df$powerPlayGoals.home)]
df$team_id.away[is.na(df$faceOffWinPercentage.home)]
df$team_id.away[is.na(df$giveaways.home)]
df$team_id.away[is.na(df$takeaways.home)]
df$team_id.away[is.na(df$blocked.home)]
```
```{r}
df$team_id.home[is.na(df$shots.away)]
df$team_id.home[is.na(df$hits.away)]
df$team_id.home[is.na(df$pim.away)]
df$team_id.home[is.na(df$powerPlayOpportunities.away)]
df$team_id.home[is.na(df$powerPlayGoals.away)]
df$team_id.home[is.na(df$faceOffWinPercentage.away)]
df$team_id.home[is.na(df$giveaways.away)]
df$team_id.home[is.na(df$takeaways.away)]
df$team_id.home[is.na(df$blocked.away)]
df$team_id.home[is.na(df$shots.home)]
df$team_id.home[is.na(df$hits.home)]
df$team_id.home[is.na(df$pim.home)]
df$team_id.home[is.na(df$powerPlayOpportunities.home)]
df$team_id.home[is.na(df$powerPlayGoals.home)]
df$team_id.home[is.na(df$faceOffWinPercentage.home)]
df$team_id.home[is.na(df$giveaways.home)]
df$team_id.home[is.na(df$takeaways.home)]
df$team_id.home[is.na(df$blocked.home)]
```
Z výpisov môžeme vidieť, že sa čísla tímov pre všetky atribúty obsahujúce N/A hodnoty opakujú. Z toho vyplýva, že všetky N/A hodnoty v našom datasete sú z práve týchto 4 konkrétnych zápasov. Tieto zápasy pre nás teda nemajú žiadny prínos, pretože im chýbajú hodnoty veľkého množstva atribútov. Z tohto dôvodu nebudeme N/A hodnoty nijakým spôsobom nahrádzať a záznamy o daných zápasoch z datesetu jednoducho vymažeme.

```{r}
df = df[!(is.na(df$shots.away))]
cbind(lapply(lapply(df, is.na), sum))
```
Ako môžeme vidieť z výpisu vyššie, po odstránení záznamov, ktoré obsahujú N/A hodnoty v atribúte **shots.away**, zmizli všetky N/A hodnoty z celého datasetu, čím sme opäť overili, že všetky N/A hodnoty pochádzali z rovnakých 4 záznamov.


